<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Lavoro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: white;
            overflow: hidden;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            margin: 0;
        }
        
        .top-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 100;
            min-height: 70px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .back-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-2px);
        }
        
        .header-title {
            font-size: 18px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .action-icon {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            min-width: 65px;
            gap: 4px;
        }
        
        .action-icon:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .action-icon svg {
            width: 18px;
            height: 18px;
        }
        
        .action-icon span {
            font-size: 10px;
            font-weight: 500;
            text-align: center;
            line-height: 1;
            white-space: nowrap;
        }
        
        .header-spacer {
            flex: 1;
        }
        
        /* Nuova sezione pulsanti scorrevole */
        .actions-bar {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
            position: sticky;
            top: 70px;
            z-index: 99;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .actions-scroll-container {
            display: flex;
            gap: 12px;
            padding: 0 16px;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }
        
        .actions-scroll-container::-webkit-scrollbar {
            display: none;
        }
        
        /* Indicatore di scroll per mobile */
        .actions-bar::after {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 20px;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.8));
            pointer-events: none;
            z-index: 1;
        }
        
        .actions-scroll-container .action-icon {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
            flex-shrink: 0;
            min-width: 80px;
            padding: 12px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .actions-scroll-container .action-icon:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .actions-scroll-container .action-icon svg {
            width: 22px;
            height: 22px;
        }
        
        .actions-scroll-container .action-icon span {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
        }
        
        /* Nuovi stili per i pulsanti azioni principali */
        .actions-section {
            margin-top: 24px;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        
        .actions-section .section-header {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            text-align: center;
            padding: 16px;
        }
        
        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        
        .action-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            overflow: hidden;
            min-height: 80px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 14px;
        }
        
        .action-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: currentColor;
        }
        
        .action-btn:hover::before {
            opacity: 0.1;
        }
        
        .action-btn:active {
            transform: translateY(-2px);
        }
        
        .action-btn-icon {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .action-btn-icon svg {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover .action-btn-icon {
            transform: scale(1.1);
        }
        
        .action-btn-content {
            flex: 1;
            text-align: left;
        }
        
        .action-btn-title {
            display: block;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            transition: color 0.3s ease;
        }
        
        .action-btn-subtitle {
            display: block;
            font-size: 13px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        
        .action-btn:hover .action-btn-subtitle {
            opacity: 0.9;
        }
        
        /* Stili specifici per ogni pulsante */
        .save-btn {
            color: #28a745;
        }
        
        .save-btn::before {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .save-btn .action-btn-icon {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .delete-btn {
            color: #dc3545;
        }
        
        .delete-btn::before {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        .delete-btn .action-btn-icon {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }
        
        .move-btn {
            color: #6f42c1;
        }
        
        .move-btn::before {
            background: linear-gradient(135deg, #6f42c1, #8e44ad);
        }
        
        .move-btn .action-btn-icon {
            background: linear-gradient(135deg, #6f42c1, #8e44ad);
            color: white;
        }
        
        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            margin-top: 0;
        }
        
        .navigation-history {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
        }
        
        @media (max-width: 768px) {
            .top-header {
                padding: 8px 12px;
                flex-wrap: nowrap;
                min-height: 60px;
            }
            
            .header-left {
                gap: 8px;
                flex: 0 0 auto;
            }
            
            .back-button {
                padding: 6px 8px;
                font-size: 12px;
            }
            
            .header-title {
                font-size: 14px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Aggiorna stili per la nuova barra azioni mobile */
            .actions-bar {
                top: 60px;
                padding: 12px 0;
            }
            
            .actions-scroll-container {
                gap: 8px;
                padding: 0 12px;
            }
            
            .actions-scroll-container .action-icon {
                min-width: 70px;
                padding: 12px 14px;
                gap: 6px;
                border-radius: 12px;
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(0, 0, 0, 0.1);
                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            }
            
            .actions-scroll-container .action-icon svg {
                width: 24px;
                height: 24px;
            }
            
            .actions-scroll-container .action-icon span {
                font-size: 12px;
                line-height: 1.2;
                font-weight: 600;
            }
            
            .header-spacer {
                flex: 0 0 auto;
                width: 20px;
            }
            
            .main-content {
                padding: 12px;
            }
            
            .main-details .section-content {
                padding: 16px;
            }
            
            .section-content {
                padding: 12px;
            }
            
            .app-view {
                padding: 8px;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 1000;
                background: white;
            }
            
            .app-view-header {
                margin-bottom: 16px;
                padding: 12px 8px;
                background: white;
                position: sticky;
                top: 0;
                z-index: 10;
                border-bottom: 2px solid #e0e0e0;
            }
            
            .app-view-header h2 {
                font-size: 18px;
            }
            
            .back-btn {
                font-size: 14px;
                padding: 8px 12px;
                background: #f8f9fa;
                border-radius: 8px;
                transition: background-color 0.2s;
            }
            
            .back-btn:hover {
                background: #e9ecef;
            }
            
            /* Chat mobile specific styles */
            .comments-list {
                max-height: calc(100vh - 200px);
                min-height: calc(100vh - 200px);
                margin-bottom: 120px;
                padding: 12px;
            }
            
            .comment-input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 12px;
                border-top: 2px solid #e0e0e0;
                z-index: 1001;
            }
            
            .comment-input {
                padding: 12px 16px;
                border-radius: 20px;
                background: #f0f2f5;
                gap: 10px;
            }
            
            .comment-input textarea {
                font-size: 16px;
                min-height: 20px;
                padding: 8px 0;
            }
            
            .comment-input button {
                padding: 10px;
                width: 40px;
                height: 40px;
            }
            
            .comment-input button:last-child {
                width: 40px;
                height: 40px;
            }
            
            .file-list {
                margin-top: 8px;
                margin-bottom: 8px;
            }
            
            /* Pulsante delete più visibile su mobile */
            .delete-comment {
                width: 36px;
                height: 36px;
                top: 12px;
                right: 12px;
                opacity: 1;
                box-shadow: 0 3px 8px rgba(220, 53, 69, 0.4);
            }
            
            .delete-comment {
                font-size: 18px;
                font-weight: bold;
                color: white;
            }
            
            /* Pulsanti azioni mobile ottimizzati */
            .action-buttons-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 16px;
            }
            
            .action-btn {
                padding: 16px;
                min-height: 70px;
                border-radius: 12px;
            }
            
            .action-btn-icon {
                width: 44px;
                height: 44px;
                border-radius: 10px;
            }
            
            .action-btn-icon svg {
                width: 22px;
                height: 22px;
            }
            
            .action-btn-title {
                font-size: 15px;
            }
            
            .action-btn-subtitle {
                font-size: 12px;
            }
            
            .actions-section .section-header {
                padding: 12px;
            }
            
            /* Fornitori mobile ottimizzati */
            .supplier-item {
                padding: 14px;
                border-radius: 10px;
                margin-bottom: 10px;
            }
            
            .supplier-item h3 {
                font-size: 16px;
                padding-right: 80px;
                margin-bottom: 10px;
            }
            
            .supplier-item p {
                font-size: 13px;
                padding-right: 80px;
                margin-bottom: 6px;
            }
            
            .remove-supplier {
                top: 10px;
                right: 10px;
                padding: 6px;
            }
            
            .confirm-supplier {
                top: 10px;
                right: 40px;
                padding: 6px;
            }
            
            .remove-supplier,
            .confirm-supplier {
                font-size: 14px;
                font-weight: bold;
            }
        }
        .main-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #f8f9fa;
            min-height: 0;
        }
        
        .section-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .section-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }
        
        .section-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: #495057;
            margin: 0;
        }
        
        .section-content {
            padding: 16px;
        }
        
        /* Sezione principale dei dettagli del lavoro - più spaziosa */
        .main-details {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .main-details .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
        }
        
        .main-details .section-title {
            color: white;
            font-size: 18px;
        }
        
        .main-details .section-content {
            padding: 24px;
        }
        
        .main-details .edit-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .main-details .edit-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .field-group {
            margin-bottom: 20px;
        }
        
        .field-label {
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 8px;
            display: block;
        }
        
        .field-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .field-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .field-display {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 14px;
            color: #495057;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 14px;
        }
        
        .info-value {
            color: #495057;
            font-size: 14px;
        }
        
        .edit-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .edit-button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        h1, h2 {
            margin-bottom: 20px;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button.edit-riferimento{
            padding: 0px 15px;
        }
        button.edit-client{
            padding: 0px 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .delete-comment{
            color: red;
            background-color: transparent;
        }
        .comments {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 16px;
            max-height: calc(100vh - 250px);
            min-height: 300px;
        }
        
        .comment {
            background: white;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            border-left: 4px solid #007bff;
        }
        
        .comment p {
            margin: 0 0 8px 0;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .comment small {
            color: #6c757d;
            font-size: 12px;
            display: block;
            margin-top: 8px;
        }
        
        .comment img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 8px 0;
            cursor: pointer;
            max-height: 300px;
            object-fit: cover;
        }
        
        .system-comment {
            color: #28a745 !important;
            font-style: italic;
            background: #f8fff8 !important;
            border-left-color: #28a745 !important;
        }
        .comment-input-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #fff;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
        }
        .comment-input {
            display: flex;
            align-items: flex-end;
            background-color: #f0f2f5;
            border-radius: 24px;
            padding: 8px 16px;
            gap: 8px;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        
        .comment-input:focus-within {
            border-color: #007bff;
        }
        
        .comment-input textarea {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            padding: 8px 0;
            min-height: 24px;
            max-height: 100px;
            font-size: 14px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            line-height: 1.4;
        }
        
        .comment-input textarea:focus {
            outline: none;
        }
        
        .comment-input textarea::placeholder {
            color: #8e8e93;
        }
        
        .comment-input button {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            border-radius: 50%;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .comment-input button:hover {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
            transform: scale(1.1);
        }
        
        .comment-input button:last-child {
            background-color: #007bff;
            width: 32px;
            height: 32px;
            padding: 0;
            color: white;
        }
        
        .comment-input button:last-child:hover {
            background-color: #0056b3;
            transform: scale(1.1);
        }
        
        .comment-input button:last-child:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .comment-input button svg {
            width: 20px;
            height: 20px;
        }
        .file-input {
            display: none;
        }
        .icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
            stroke: currentColor;
            fill: none;
        }
        #fornitoreSuggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none; /* Hidden by default */
            width: 100%; /* Match input width */
        }
        #fornitoreSuggestions div {
            padding: 10px;
            cursor: pointer;
        }
        #fornitoreSuggestions div:hover {
            background-color: #f0f2f5;
        }
        #current-supplier, #client-info, #riferimento-info {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #current-supplier h3, #client-info h2, #riferimento-info h2 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        #current-supplier p, #client-info p, #riferimento-info p {
            margin-bottom: 5px;
        }
        .file-list {
            margin-top: 10px;
            font-size: 14px;
            position: relative;
        }

        .file-list .upload-progress {
            display: inline-block;
            margin-left: 10px;
            color: #666;
        }
        .delete-comment {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.9;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        }
        
        .delete-comment:hover {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        .delete-comment {
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        #current-suppliers {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #current-suppliers h3 {
            margin-bottom: 30px;
            font-size: 16px;
        }
        #current-suppliers p {
            margin-bottom: 5px;
        }
        .supplier-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .supplier-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-color: #007bff;
        }
        .supplier-item h3 {
            margin-bottom: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            padding-right: 100px;
            line-height: 1.3;
        }
        
        .supplier-item p {
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
            color: #495057;
            padding-right: 100px;
        }
        
        .supplier-item p strong {
            color: #212529;
            font-weight: 600;
        }
        .remove-supplier {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 8px;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        
        .remove-supplier:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.4);
        }
        
        .remove-supplier {
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        
        .confirm-supplier {
            position: absolute;
            top: 12px;
            right: 50px;
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 8px;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        
        .confirm-supplier:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4);
        }
        
        .confirm-supplier {
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        .form-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #fff;
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
        }
        .form-footer button {
            margin-left: 10px;
        }
        .recommend-suppliers {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 8px;
            background: linear-gradient(to right, #FF00FF, #800080);
            color: white;
            cursor: pointer;
            transition: opacity 0.3s;
            float: right; /* Align to the right */
        }
        .recommend-suppliers:hover {
            opacity: 0.9;
        }
        .recommend-suppliers svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            margin-left: 8px;
        }
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .popup-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 450px;
            text-align: center;
            position: relative;
        }
        .popup-content h3 {
            margin-bottom: 15px;
        }
        .popup-content textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .popup-content button {
            padding: 10px 15px;
            color: rgb(0, 0, 0);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .popup-content button:hover {
            background-color: #ffffff00;
        }
        .popup-close {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: black;
        }
        .system-comment {
            font-weight: bold;
            text-align: center;
        }
        .pdf-preview {
            height: 400px; /* Increase the height */
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            justify-content: center; /* Center the canvas horizontally */
            align-items: flex-start;
        }
        .pdf-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .pdf-viewer-controls {
            position: absolute;
            top: 10px;
            right: 50px;
            z-index: 1001;
            display: flex;
            gap: 10px;
        }
        .pdf-viewer-button {
            background-color: white;
            color: black;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            border-radius: 4px;
        }
        .camera-options {
            position: absolute;
            bottom: 50px;
            right: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
        }
        .camera-options button {
            display: block;
            width: 100%;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
        }
        .camera-options button:hover {
            background-color: #f0f2f5;
        }
        .camera-options button:last-child {
            background-color: transparent;
            border-radius: 0;
            width: auto;
            height: auto;
            padding: 10px;
            color: black;
        }
        .loading-bar-container {
            width: 100%;
            height: 4px;
            background-color: #f0f2f5;
            position: relative;
            margin-top: 5px;
            display: none;
        }

        .loading-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }

        .preview-comment {
            opacity: 0.7;
            background-color: #f8f9fa !important;
        }

        .preview-comment::before {
            content: "Caricamento in corso... non chiudere la finestra";
            display: block;
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 5px;
        }
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                min-height: 100%;
                padding-bottom: 140px; /* Spazio per entrambe le barre fisse */
            }
            .work-details {
                padding-bottom: 20px;
            }
            .comments {
                padding-bottom: 20px;
            }
            .comment-input-container {
                position: fixed;
                bottom: 60px; /* Lascia spazio per il pulsante salva */
                left: 0;
                right: 0;
                background: white;
                z-index: 100;
                padding: 10px;
                border-top: 1px solid #e0e0e0;
            }
            .form-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: #fff;
                padding: 10px;
                border-top: 1px solid #e0e0e0;
                z-index: 101;
                height: 60px;
            }
            .comments-list {
                margin-bottom: 100px; /* Spazio per evitare che i commenti finiscano sotto l'input */
            }
            .divider {
                display: none;
            }
        }
        .comments-header {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Changed from space-between to flex-start */
            margin-bottom: 20px;
        }
        .comments-header h2 {
            margin-bottom: 0; /* Remove bottom margin from h2 */
            margin-right: 10px; /* Add space between the text and icon */
        }
        .mail-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .mail-btn:hover {
            background-color: #e0e0e0;
        }
        .mail-btn svg {
            width: 24px;
            height: 24px;
            fill: #007bff;
        }
        /* Email form styles */
        .email-form {
            display: none; /* Hidden by default */
        }
        .email-field {
            margin-bottom: 20px;
        }
        .email-field label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .email-field input, .email-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .email-field textarea {
            min-height: 200px;
            resize: vertical;
        }
        .email-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .send-email-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .send-email-btn:hover {
            background-color: #218838;
        }
        .cancel-email-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .cancel-email-btn:hover {
            background-color: #c82333;
        }
        .email-attachments {
            margin-top: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            grid-gap: 15px;
        }
        
        .attachment-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .attachment-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .attachment-thumbnail img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .attachment-thumbnail.pdf {
            background-color: #f8d7da;
        }
        
        .attachment-thumbnail.pdf svg {
            width: 40px;
            height: 40px;
            color: #dc3545;
        }
        
        .attachment-thumbnail.document {
            background-color: #d1ecf1;
        }
        
        .attachment-thumbnail.document svg {
            width: 40px;
            height: 40px;
            color: #0c5460;
        }
        
        .attachment-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 1;
        }
        
        .attachment-name {
            font-size: 13px;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        
        .attachment-date {
            font-size: 11px;
            color: #6c757d;
        }
        
        .attachment-controls {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 5px;
            margin-top: 10px;
        }
        
        .select-all-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
        }
        
        .select-all-btn:hover {
            background-color: #0069d9;
        }
        
        .email-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .attachment-count {
            font-size: 14px;
            color: #495057;
        }
        
        .attachment-count strong {
            color: #007bff;
        }
        .sending-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .sending-message {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .email-chips-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            background-color: white;
            min-height: 42px;
            align-items: center;
            position: relative;
        }

        .email-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .email-chip {
            background-color: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 16px;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            max-width: 200px;
        }

        .email-chip span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .email-chip button {
            background: none;
            border: none;
            color: #666;
            padding: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            border-radius: 50%;
        }

        .email-chip button:hover {
            background-color: #90caf9;
            color: white;
        }

        #email-to {
            border: none;
            flex: 1;
            min-width: 150px;
            padding: 8px;
            font-size: 14px;
        }

        #email-to:focus {
            outline: none;
        }

        .invalid-email {
            background-color: #ffebee;
            border-color: #ef9a9a;
        }
        .email-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
            margin-top: 5px; /* Add margin to push suggestions below the input field */
        }
        
        .email-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .email-suggestion:hover,
        .email-suggestion.selected {
            background-color: #f0f8ff;
        }
        
        .email-suggestion:last-child {
            border-bottom: none;
        }

        /* Stili per l'interfaccia telefono - rimosso sfondo viola */
        .phone-interface {
            background: transparent;
            border-radius: 0;
            padding: 0;
            display: none; /* Nascosto per default */
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .phone-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            z-index: 1;
        }

        .phone-time {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .phone-date {
            font-size: 14px;
            opacity: 0.8;
        }



        /* Stili per le viste delle app */
        .app-view {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 50;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            min-height: 100vh;
        }

        .app-view.active {
            display: block;
        }

        .app-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .back-btn {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            cursor: pointer;
            font-size: 16px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .back-btn:hover {
            background: #e9ecef;
            color: #212529;
            transform: translateX(-2px);
        }

        /* Stili per lo storico modifiche */
        .history-item {
            background: white;
            border: 1px solid #e9ecef;
            border-left: 4px solid #007bff;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.2s ease;
        }

        .history-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-action {
            font-weight: 600;
            color: #007bff;
            font-size: 15px;
        }

        .history-date {
            font-size: 12px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .history-details {
            font-size: 14px;
            color: #495057;
            line-height: 1.4;
        }

        /* Stili per la vista file */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            padding: 8px;
        }

        .file-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        .file-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e9ecef;
        }

        .file-name {
            font-size: 12px;
            font-weight: 500;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.3;
        }
        
        @media (max-width: 768px) {
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 12px;
                padding: 4px;
            }
            
            .file-item {
                padding: 10px;
            }
            
            .file-thumbnail {
                height: 80px;
            }
            
            .file-name {
                font-size: 11px;
            }
        }
        
        /* Loading animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="top-header">
            <div class="header-left">
                <button class="back-button" onclick="navigateBack()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Indietro
                </button>
                <div class="header-title">Gestione Ticket</div>
            </div>
        </div>
        
        <!-- Sezione pulsanti scorrevole -->
        <div class="actions-bar">
            <div class="actions-scroll-container">
                <button class="action-icon" onclick="openChatView()" title="Chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Chat</span>
                </button>
                <button class="action-icon" onclick="openWhatsAppView()" title="WhatsApp">
                    <svg viewBox="0 0 24 24" fill="#25D366">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.50002 12C3.50002 7.30558 7.3056 3.5 12 3.5C16.6944 3.5 20.5 7.30558 20.5 12C20.5 16.6944 16.6944 20.5 12 20.5C10.3278 20.5 8.77127 20.0182 7.45798 19.1861C7.21357 19.0313 6.91408 18.9899 6.63684 19.0726L3.75769 19.9319L4.84173 17.3953C4.96986 17.0955 4.94379 16.7521 4.77187 16.4751C3.9657 15.176 3.50002 13.6439 3.50002 12ZM12 1.5C6.20103 1.5 1.50002 6.20101 1.50002 12C1.50002 13.8381 1.97316 15.5683 2.80465 17.0727L1.08047 21.107C0.928048 21.4637 0.99561 21.8763 1.25382 22.1657C1.51203 22.4552 1.91432 22.5692 2.28599 22.4582L6.78541 21.1155C8.32245 21.9965 10.1037 22.5 12 22.5C17.799 22.5 22.5 17.799 22.5 12C22.5 6.20101 17.799 1.5 12 1.5ZM14.2925 14.1824L12.9783 15.1081C12.3628 14.7575 11.6823 14.2681 10.9997 13.5855C10.2901 12.8759 9.76402 12.1433 9.37612 11.4713L10.2113 10.7624C10.5697 10.4582 10.6678 9.94533 10.447 9.53028L9.38284 7.53028C9.23954 7.26097 8.98116 7.0718 8.68115 7.01654C8.38113 6.96129 8.07231 7.046 7.84247 7.24659L7.52696 7.52195C6.76823 8.18414 6.3195 9.2723 6.69141 10.3741C7.07698 11.5163 7.89983 13.314 9.58552 14.9997C11.3991 16.8133 13.2413 17.5275 14.3186 17.8049C15.1866 18.0283 16.008 17.7288 16.5868 17.2572L17.1783 16.7752C17.4313 16.5691 17.5678 16.2524 17.544 15.9269C17.5201 15.6014 17.3389 15.308 17.0585 15.1409L15.3802 14.1409C15.0412 13.939 14.6152 13.9552 14.2925 14.1824Z"/>
                    </svg>
                    <span>WhatsApp</span>
                </button>
                <button class="action-icon" onclick="openEmailView()" title="Email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <span>Email</span>
                </button>
                <button class="action-icon" onclick="openFilesView()" title="File">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
                        <polyline points="13,2 13,9 20,9"/>
                    </svg>
                    <span>File</span>
                </button>
                <button class="action-icon" onclick="openHistoryView()" title="Storico">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                        <path d="M3 3v5h5"/>
                        <path d="M12 7v5l4 2"/>
                    </svg>
                    <span>Storico</span>
                </button>
            </div>
        </div>
        
        <div class="content-wrapper">
            <div class="main-content" id="mainContent">
                <!-- Sezione Dettagli Cliente -->
                <!-- Sezione Dettagli Cliente - Principale -->
                <div class="main-details">
                    <div class="section-header">
                        <h2 class="section-title">Dettagli Cliente</h2>
                        <button class="edit-button" onclick="showEditClientModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Modifica
                        </button>
                    </div>
                    <div class="section-content" id="client-info">
                        <!-- Contenuto generato dinamicamente -->
                    </div>
                </div>
                <!-- Sezione Dettagli Riferimento - Principale -->
                <div class="main-details" id="riferimento-section">
                    <div class="section-header">
                        <h2 class="section-title">Dettagli Riferimento</h2>
                        <div id="riferimento-actions">
                            <button class="edit-button" onclick="showEditRiferimentoModal()" id="edit-riferimento-btn" style="display: none;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                Modifica
                            </button>
                            <button class="edit-button" onclick="removeRiferimento()" id="remove-riferimento-btn" style="display: none; background: rgba(220, 53, 69, 0.8); margin-left: 8px;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    <line x1="10" y1="11" x2="10" y2="17"/>
                                    <line x1="14" y1="11" x2="14" y2="17"/>
                                </svg>
                                Rimuovi
                            </button>
                            <button class="edit-button" onclick="showAddRiferimentoModal()" id="add-riferimento-btn">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                </svg>
                                Aggiungi
                            </button>
                        </div>
                    </div>
                    <div class="section-content" id="riferimento-details">
                        <div class="field-display">Nessun riferimento associato</div>
                    </div>
                </div>

                <!-- Sezione Importo -->
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Importo</h2>
                    </div>
                    <div class="section-content">
                        <div class="field-group">
                            <input type="number" id="importo" class="field-input" step="0.01" placeholder="Inserisci importo...">
                        </div>
                    </div>
                </div>

                <!-- Sezione Descrizione -->
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Descrizione</h2>
                    </div>
                    <div class="section-content">
                        <div class="field-group">
                            <textarea id="descrizione" class="field-input" rows="4" placeholder="Descrizione del lavoro..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sezione Fase -->
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Fase</h2>
                    </div>
                    <div class="section-content">
                        <div class="field-group">
                            <select id="fase" class="field-input">
                                <option value="in_sospeso_per_valutazioni">In sospeso per valutazioni</option>
                                <option value="nuovo_sopralluogo" selected>Nuovo sopralluogo</option>
                                <option value="da_preventivare">Da preventivare</option>
                                <option value="inviato_preventivo">Inviato preventivo</option>
                                <option value="confermato_da_eseguire">Confermato da eseguire</option>
                                <option value="con_piattaforma_o_fune">In corso o In Lavorazione</option>
                                <option value="in_corso">In corso</option>
                                <option value="da_fatturare">Da fatturare</option>
                                <option value="fatturate_da_pagare">Fatturato da pagare</option>
                                <option value="archiviate">Archiviate</option>
                                <option value="offerte_perse">Offerte Perse</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sezione Note -->
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Note</h2>
                    </div>
                    <div class="section-content">
                        <div class="field-group">
                            <textarea id="note" class="field-input" rows="3" placeholder="Note aggiuntive..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Sezione Fornitori -->
                <div class="section-card">
                    <div class="section-header">
                        <h2 class="section-title">Fornitori Selezionati</h2>
                        <button class="edit-button" onclick="consigliaFornitori()" style="background: linear-gradient(135deg, #FF00FF, #800080);">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <polygon points="12,2 14,10 22,12 14,14 12,22 10,14 2,12 10,10"/>
                            </svg>
                            Consiglia
                        </button>
                    </div>
                    <div class="section-content">
                        <div class="field-group">
                            <input type="text" id="fornitore" class="field-input" placeholder="Cerca fornitore..." oninput="cercaFornitore(this.value)">
                            <div id="fornitoreSuggestions"></div>
                        </div>
                        <div id="current-suppliers">
                            <!-- Contenuto generato dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Sezione Azioni Principali -->
                <div class="section-card actions-section">
                    <div class="section-header">
                        <h2 class="section-title">Azioni Ticket</h2>
                    </div>
                    <div class="section-content">
                        <div class="action-buttons-grid">
                            <button type="button" onclick="salvaModifiche()" class="action-btn save-btn" aria-label="Salva le modifiche del ticket">
                                <div class="action-btn-icon">
                                    <img src="/static/save icon.png" alt="Salva" style="width: 24px; height: 24px;">
                                </div>
                                <div class="action-btn-content">
                                    <span class="action-btn-title">Salva</span>
                                    <span class="action-btn-subtitle">Conferma modifiche</span>
                                </div>
                            </button>
                            
                            <button type="button" onclick="showDeleteConfirmation()" class="action-btn delete-btn" aria-label="Elimina definitivamente il ticket">
                                <div class="action-btn-icon">
                                    ×
                                </div>
                                <div class="action-btn-content">
                                    <span class="action-btn-title">Elimina</span>
                                    <span class="action-btn-subtitle">Rimuovi ticket</span>
                                </div>
                            </button>
                            
                            <button type="button" onclick="showMoveModal()" class="action-btn move-btn" aria-label="Sposta il ticket in un'altra fase">
                                <div class="action-btn-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <path d="M18 8L22 12L18 16"/>
                                        <path d="M2 12H22"/>
                                        <path d="M6 8L2 12L6 16"/>
                                    </svg>
                                </div>
                                <div class="action-btn-content">
                                    <span class="action-btn-title">Sposta</span>
                                    <span class="action-btn-subtitle">Cambia fase</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Nascosto: form originale per compatibilità -->
            <form id="work-form" style="display: none;">
                <input type="hidden" id="fornitore_id" name="fornitore_id">
            </form>
        </div>
        
        <div class="email-form" id="email-form">
            <h1>Invia Email</h1>
            <div class="email-field">
                <label for="email-to">Destinatari:</label>
                <div class="email-chips-container">
                    <div class="email-chips"></div>
                    <input type="text" id="email-to" name="email-to" placeholder="Inserisci gli indirizzi email..." autocomplete="off">
                    <div id="email-suggestions" class="email-suggestions"></div>
                </div>
            </div>
            <div class="email-field">
                <label for="email-subject">Oggetto:</label>
                <input type="text" id="email-subject" name="email-subject" required>
            </div>
            <div class="email-field">
                <label for="email-body">Corpo:</label>
                <textarea id="email-body" name="email-body"></textarea>
            </div>
            <div class="email-field">
                <label>Allegati:</label>
                <div class="email-actions">
                    <span class="attachment-count">Seleziona gli allegati da includere</span>
                    <button type="button" class="select-all-btn" id="toggle-attachments">Deseleziona tutti</button>
                </div>
                <div id="email-attachments" class="email-attachments">
                    <p>Caricamento degli allegati dai commenti...</p>
                </div>
            </div>
            <div class="email-buttons">
                <button class="cancel-email-btn" onclick="toggleEmailForm()">Annulla</button>
                <button class="send-email-btn" onclick="sendEmail()">
                    <img src="/static/save icon.png" alt="Invia" style="width: 16px; height: 16px; margin-right: 6px;">
                    Invia
                </button>
            </div>
        </div>
        
        <div class="divider"></div>
        <div class="comments" id="phoneSection">
            <!-- Interfaccia telefono -->
            <div class="phone-interface" id="phoneInterface">
                <div class="phone-header">
                    <!-- Rimosso data e ora -->
                </div>
                



            </div>

            <!-- Vista Chat -->
            <div class="app-view" id="chatView">
                <div class="app-view-header">
                    <button class="back-btn" onclick="closeApp()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Indietro
                    </button>
                    <h2>Chat</h2>
                    <div></div>
                </div>
                <div id="commenti-list" class="comments-list"></div>
                <div class="comment-input-container">
                    <div class="comment-input">
                        <textarea 
                            id="nuovo-commento" 
                            placeholder="Scrivi un commento..."
                            rows="1"
                            oninput="this.style.height = '';this.style.height = this.scrollHeight + 'px'; updateSendButton()"
                        ></textarea>
                        <input type="file" id="file-commento" class="file-input" accept="*/*" multiple onchange="updateSendButton(); showFileList(this.files)">
                        <button onclick="document.getElementById('file-commento').click()">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />
                            </svg>
                        </button>
                        <button onclick="toggleCameraOptions()">
                            <svg class="icon" viewBox="0 0 24 24">
                                <path d="M12 2l3 3h4a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l3-3zM12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" />
                            </svg>
                        </button>
                        <div class="camera-options" id="camera-options">
                            <button onclick="document.getElementById('foto-commento').click()">Scatta foto</button>
                            <button onclick="document.getElementById('file-commento').click()">Carica foto</button>
                        </div>
                        <input type="file" id="foto-commento" class="file-input" accept="image/*" capture="environment" style="display: none;">
                        <button id="send-button" onclick="aggiungiCommento()" disabled>
                            <img src="/static/save icon.png" alt="Invia" style="width: 18px; height: 18px;">
                        </button>
                    </div>
                    <div class="loading-bar-container">
                        <div class="loading-bar"></div>
                    </div>
                    <div id="file-list" class="file-list"></div>
                </div>
            </div>

            <!-- Vista Storico -->
            <div class="app-view" id="historyView">
                <div class="app-view-header">
                    <button class="back-btn" onclick="closeApp()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Indietro
                    </button>
                    <h2>Storico Modifiche</h2>
                    <div></div>
                </div>
                <div id="history-list">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
                        <p>Caricamento storico...</p>
                    </div>
                </div>
            </div>

            <!-- Vista File -->
            <div class="app-view" id="filesView">
                <div class="app-view-header">
                    <button class="back-btn" onclick="closeApp()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                        </svg>
                        Indietro
                    </button>
                    <h2>File e Media</h2>
                    <div></div>
                </div>
                <div class="file-grid" id="files-grid">
                    <div style="text-align: center; color: #666; padding: 40px; grid-column: 1 / -1;">
                        <div style="display: inline-block; width: 32px; height: 32px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
                        <p>Caricamento file...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Add the confirmation modal markup before the closing body tag -->
    <div id="confirmationModal" class="confirmation-modal" style="display: none; position: fixed; z-index: 1100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="confirmation-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center; border-radius: 8px;">
            <p>Sei sicuro di voler eliminare questo commento?</p>
            <div class="confirmation-buttons" style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button class="confirm" onclick="confirmDelete()" style="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background-color: #4CAF50; color: white;">Conferma</button>
                <button class="cancel" onclick="cancelDelete()" style="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background-color: #f44336; color: white;">Annulla</button>
            </div>
        </div>
    </div>
    <!-- Add supplier deletion confirmation modal -->
    <div id="supplierConfirmationModal" class="confirmation-modal" style="display: none; position: fixed; z-index: 1100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
        <div class="confirmation-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center; border-radius: 8px;">
            <p>Sei sicuro di voler eliminare questo fornitore?</p>
            <div class="confirmation-buttons" style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button class="confirm" onclick="confirmSupplierDelete()" style="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background-color: #4CAF50; color: white;">Conferma</button>
                <button class="cancel" onclick="cancelSupplierDelete()" style="padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background-color: #f44336; color: white;">Annulla</button>
            </div>
        </div>
    </div>
    <!-- ...existing code... -->

    <div class="popup-overlay" id="popup-overlay" style="display: none;">
        <div class="popup-content">
            <button class="popup-close" onclick="chiudiPopup()">×</button>
            <h3>Inserisci note facoltative</h3>
            <textarea id="popup-notes" rows="4"></textarea>
            <button onclick="continuaConsigliaFornitori()">
                <img src="/static/save icon.png" alt="Continua" style="width: 16px; height: 16px; margin-right: 6px;">
                Continua
            </button>
        </div>
    </div>
    <!-- Modal for editing reference -->
    <div id="editRiferimentoModal" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <button class="popup-close" onclick="closeEditRiferimentoModal()">×</button>
            <h3>Modifica Riferimento</h3>
            <form id="edit-riferimento-form">
                <div class="form-group">
                    <label for="edit-riferimento-nome">Nome</label>
                    <input type="text" id="edit-riferimento-nome" name="nome" >
                </div>
                <div class="form-group">
                    <label for="edit-riferimento-cognome">Cognome</label>
                    <input type="text" id="edit-riferimento-cognome" name="cognome" >
                </div>
                <div class="form-group">
                    <label for="edit-riferimento-telefono">Telefono</label>
                    <input type="text" id="edit-riferimento-telefono" name="telefono" >
                </div>
                <div class="form-group">
                    <label for="edit-riferimento-email">Email</label>
                    <input type="email" id="edit-riferimento-email" name="email" >
                </div>
                <button type="submit">
                    <img src="/static/save icon.png" alt="Salva" style="width: 16px; height: 16px; margin-right: 6px;">
                    Salva
                </button>
            </form>
        </div>
    </div>
    <!-- Modal for editing client -->
    <div id="editClientModal" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <button class="popup-close" onclick="closeEditClientModal()">×</button>
            <h3>Modifica Cliente</h3>
            <form id="edit-client-form">
                <div class="form-group">
                    <label for="edit-client-descrizione" style="text-align: left;">Descrizione</label>
                    <input type="text" id="edit-client-descrizione" name="descrizione" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-nome" style="text-align: left;">Nome</label>
                    <input type="text" id="edit-client-nome" name="nome" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-cognome" style="text-align: left;">Cognome</label>
                    <input type="text" id="edit-client-cognome" name="cognome" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-email" style="text-align: left;">Email</label>
                    <input type="email" id="edit-client-email" name="email" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-cellulare" style="text-align: left;">Cellulare</label>
                    <input type="text" id="edit-client-cellulare" name="cellulare" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-indirizzo" style="text-align: left;">Indirizzo</label>
                    <input type="text" id="edit-client-indirizzo" name="indirizzo" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-codice_fiscale" style="text-align: left;">Codice Fiscale</label>
                    <input type="text" id="edit-client-codice_fiscale" name="codice_fiscale" style="padding: 5px;">
                </div>
                <div class="form-group">
                    <label for="edit-client-piva" style="text-align: left;">Partita IVA</label>
                    <input type="text" id="edit-client-piva" name="piva" style="padding: 5px;">
                </div>
                <button type="submit" style="padding: 8px 12px;">
                    <img src="/static/save icon.png" alt="Salva" style="width: 16px; height: 16px; margin-right: 6px;">
                    Salva
                </button>
            </form>
        </div>
    </div>
    <!-- Modal for adding new reference -->
    <div id="addRiferimentoModal" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <button class="popup-close" onclick="closeAddRiferimentoModal()">×</button>
            <h3>Aggiungi Nuovo Riferimento</h3>
            <form id="add-riferimento-form">
                <div class="form-group">
                    <label for="add-riferimento-nome">Nome</label>
                    <input type="text" id="add-riferimento-nome" name="nome">
                </div>
                <div class="form-group">
                    <label for="add-riferimento-cognome">Cognome</label>
                    <input type="text" id="add-riferimento-cognome" name="cognome">
                </div>
                <div class="form-group">
                    <label for="add-riferimento-telefono">Telefono</label>
                    <input type="text" id="add-riferimento-telefono" name="telefono">
                </div>
                <div class="form-group">
                    <label for="add-riferimento-email">Email</label>
                    <input type="email" id="add-riferimento-email" name="email">
                </div>
                <button type="submit">
                    <img src="/static/save icon.png" alt="Aggiungi" style="width: 16px; height: 16px; margin-right: 6px;">
                    Aggiungi Riferimento
                </button>
            </form>
        </div>
    </div>
    <!-- Modal per conferma eliminazione ticket -->
    <div id="deleteConfirmationModal" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <button class="popup-close" onclick="closeDeleteModal()">×</button>
            <h3>Conferma Eliminazione</h3>
            <p>Sei sicuro di voler eliminare questo ticket? Questa azione non può essere annullata.</p>
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button onclick="confirmDelete()" style="background-color: #dc3545; color: white; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                                    ×
                    Elimina
                </button>
                <button onclick="closeDeleteModal()" style="background-color: #6c757d; color: white;">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Modal per spostare ticket -->
    <div id="moveModal" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <button class="popup-close" onclick="closeMoveModal()">×</button>
            <h3>Sposta Ticket in Colonna</h3>
            <div class="form-group">
                <label for="move-to-stage">Seleziona nuova fase:</label>
                <select id="move-to-stage" style="width: 100%; padding: 8px; margin: 10px 0;">
                    <option value="in_sospeso_per_valutazioni">In Sospeso per Valutazioni</option>
                    <option value="nuovo_sopralluogo">Nuovo Sopralluogo</option>
                    <option value="da_preventivare">Da Preventivare</option>
                    <option value="inviato_preventivo">Inviato Preventivo</option>
                    <option value="confermato_da_eseguire">Confermato da Eseguire</option>
                    <option value="con_piattaforma_o_fune">In corso o In Lavorazione</option>
                    <option value="in_corso">In Corso</option>
                    <option value="da_fatturare">Da Fatturare</option>
                    <option value="fatturate_da_pagare">Fatturato da Pagare</option>
                    <option value="archiviate">Archiviate</option>
                    <option value="offerte_perse">Offerte Perse</option>
                </select>
            </div>
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button onclick="confirmMove()" style="background-color: #28a745; color: white; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <img src="/static/save icon.png" alt="Sposta" style="width: 16px; height: 16px; filter: brightness(0) invert(1);">
                    Sposta
                </button>
                <button onclick="closeMoveModal()" style="background-color: #6c757d; color: white;">Annulla</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        let workData;
        let fornitori = [];
        let selectedFornitori = [];
        let savedEmails = [];
        let allContacts = []; // Nuovo array per tutti i contatti
        
        // Sistema di navigazione
        let navigationHistory = [];
        let currentView = 'main';
        
        // Funzioni di navigazione
        function navigateBack() {
            if (navigationHistory.length > 0) {
                const previousView = navigationHistory.pop();
                showView(previousView);
            } else {
                // Se non c'è cronologia, chiudi l'iframe
                if (window.parent && window.parent.closeIframeFromChild) {
                    window.parent.closeIframeFromChild();
                }
            }
        }
        
        function showView(viewName) {
            // Nascondi tutte le viste app
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.remove('active');
            });
            
            // Nascondi il contenuto principale
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.style.display = viewName === 'main' ? 'block' : 'none';
            }
            
            // Mostra la vista richiesta
            switch(viewName) {
                case 'main':
                    document.querySelector('.header-title').textContent = 'Gestione Ticket';
                    break;
                case 'chat':
                    const chatView = document.getElementById('chatView');
                    if (chatView) {
                        chatView.classList.add('active');
                        document.querySelector('.header-title').textContent = 'Chat';
                    }
                    break;
                case 'history':
                    const historyView = document.getElementById('historyView');
                    if (historyView) {
                        historyView.classList.add('active');
                        document.querySelector('.header-title').textContent = 'Storico';
                        loadWorkHistory(); // Carica lo storico quando viene aperto
                    }
                    break;
                case 'files':
                    const filesView = document.getElementById('filesView');
                    if (filesView) {
                        filesView.classList.add('active');
                        document.querySelector('.header-title').textContent = 'File e Media';
                        loadWorkFiles(); // Carica i file quando viene aperto
                    }
                    break;
            }
            currentView = viewName;
            
            // Espandi l'iframe se necessario
            expandIframeIfNeeded();
        }
        
        function openChatView() {
            if (currentView !== 'chat') {
                navigationHistory.push(currentView);
                showView('chat');
                caricaCommenti(); // Carica i commenti quando si apre la chat
                
                // Assicurati che l'input sia visibile su mobile
                setTimeout(() => {
                    const commentInput = document.getElementById('nuovo-commento');
                    if (commentInput) {
                        // Forza il focus per mostrare la tastiera su mobile
                        commentInput.focus();
                        // Scroll verso il basso per mostrare l'input
                        commentInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            }
        }
        
        function openEmailView() {
            // Gestisce l'email con riferimenti del ticket
            handleEmailApp();
        }
        
        function openWhatsAppView() {
            // Implementa la logica WhatsApp
            handleWhatsAppApp();
        }
        
        function openFilesView() {
            if (currentView !== 'files') {
                navigationHistory.push(currentView);
                showView('files');
            }
        }
        
        function openHistoryView() {
            if (currentView !== 'history') {
                navigationHistory.push(currentView);
                showView('history');
            }
        }
        
        // Gestione della navigazione del browser
        window.addEventListener('popstate', function(event) {
            if (navigationHistory.length > 0) {
                navigateBack();
            }
        });
        
        // Funzione per salvare le modifiche
        function salvaModifiche() {
            // Utilizza la logica esistente del form
            const form = document.getElementById('work-form');
            if (form) {
                const event = new Event('submit');
                form.dispatchEvent(event);
            } else {
                // Implementa il salvataggio diretto
                saveWorkData();
            }
        }
        
        // Funzione per aggiornare la visualizzazione del riferimento
        function updateRiferimentoDisplay(riferimento) {
            const detailsContainer = document.getElementById('riferimento-details');
            const editBtn = document.getElementById('edit-riferimento-btn');
            const removeBtn = document.getElementById('remove-riferimento-btn');
            const addBtn = document.getElementById('add-riferimento-btn');
            
            if (riferimento && (riferimento.nome || riferimento.cognome || riferimento.telefono || riferimento.email)) {
                // Mostra i dettagli del riferimento
                let html = '<div class="info-rows">';
                if (riferimento.nome) {
                    html += `<div class="info-row"><span class="info-label">Nome:</span><span class="info-value">${riferimento.nome}</span></div>`;
                }
                if (riferimento.cognome) {
                    html += `<div class="info-row"><span class="info-label">Cognome:</span><span class="info-value">${riferimento.cognome}</span></div>`;
                }
                if (riferimento.telefono) {
                    html += `<div class="info-row"><span class="info-label">Telefono:</span><span class="info-value">${riferimento.telefono}</span></div>`;
                }
                if (riferimento.email) {
                    html += `<div class="info-row"><span class="info-label">Email:</span><span class="info-value">${riferimento.email}</span></div>`;
                }
                html += '</div>';
                
                detailsContainer.innerHTML = html;
                editBtn.style.display = 'inline-block';
                removeBtn.style.display = 'inline-block';
                addBtn.style.display = 'none';
            } else {
                // Nessun riferimento
                detailsContainer.innerHTML = '<div class="field-display">Nessun riferimento associato</div>';
                editBtn.style.display = 'none';
                removeBtn.style.display = 'none';
                addBtn.style.display = 'inline-block';
            }
        }
        
        // Funzione per aggiornare la visualizzazione del cliente
        function updateClientDisplay(cliente) {
            const clientInfo = document.getElementById('client-info');
            let html = '<div class="info-rows">';
            
            if (cliente.societa) {
                if (cliente.descrizione) html += `<div class="info-row"><span class="info-label">Descrizione:</span><span class="info-value">${cliente.descrizione}</span></div>`;
                if (cliente.piva) html += `<div class="info-row"><span class="info-label">P.IVA:</span><span class="info-value">${cliente.piva}</span></div>`;
                if (cliente.indirizzo) html += `<div class="info-row"><span class="info-label">Indirizzo:</span><span class="info-value">${cliente.indirizzo}</span></div>`;
                if (cliente.cellulare) html += `<div class="info-row"><span class="info-label">Cellulare:</span><span class="info-value">${cliente.cellulare}</span></div>`;
                if (cliente.email) html += `<div class="info-row"><span class="info-label">Email:</span><span class="info-value">${cliente.email}</span></div>`;
            } else {
                if (cliente.descrizione) html += `<div class="info-row"><span class="info-label">Descrizione:</span><span class="info-value">${cliente.descrizione}</span></div>`;
                if (cliente.nome) html += `<div class="info-row"><span class="info-label">Nome:</span><span class="info-value">${cliente.nome}</span></div>`;
                if (cliente.cognome) html += `<div class="info-row"><span class="info-label">Cognome:</span><span class="info-value">${cliente.cognome}</span></div>`;
                if (cliente.email) html += `<div class="info-row"><span class="info-label">Email:</span><span class="info-value">${cliente.email}</span></div>`;
                if (cliente.cellulare) html += `<div class="info-row"><span class="info-label">Cellulare:</span><span class="info-value">${cliente.cellulare}</span></div>`;
                if (cliente.indirizzo) html += `<div class="info-row"><span class="info-label">Indirizzo:</span><span class="info-value">${cliente.indirizzo}</span></div>`;
            }
            
            html += '</div>';
            clientInfo.innerHTML = html;
        }

        // Fetch saved emails from the server
        function fetchSavedEmails() {
            fetch('/api/get_saved_emails/')
                .then(response => response.json())
                .then(data => {
                    savedEmails = data;
                })
                .catch(error => console.error('Errore durante il caricamento degli indirizzi email salvati:', error));
        }

        // Fetch fornitori when the page loads
        fetchFornitori();
        
        // Fetch saved emails when the page loads
        fetchSavedEmails();

        // Load saved emails from localStorage
        function loadSavedEmails() {
            const storedEmails = localStorage.getItem('savedEmails');
            if (storedEmails) {
                try {
                    savedEmails = JSON.parse(storedEmails);
                } catch (e) {
                    console.error('Error loading saved emails:', e);
                    savedEmails = [];
                }
            }
        }

        // Save emails to localStorage
        function saveEmails() {
            localStorage.setItem('savedEmails', JSON.stringify(savedEmails));
        }

        // Add email to saved list
        function addToSavedEmails(email) {
            if (!email || typeof email !== 'string') return;
            
            // Remove any existing instance of this email to avoid duplicates
            savedEmails = savedEmails.filter(e => e.toLowerCase() !== email.toLowerCase());
            
            // Add the new email at the beginning for recency
            savedEmails.unshift(email);
            
            // Keep the list at a reasonable size
            if (savedEmails.length > 50) {
                savedEmails = savedEmails.slice(0, 50);
            }
            
            // Save to localStorage
            saveEmails();
        }

        // Fetch fornitori when the page loads
        fetchFornitori();
        
        // Load saved emails when the page loads
        loadSavedEmails();

        function fetchFornitori() {
            fetch('/api/fornitori')
                .then(response => response.json())
                .then(data => {
                    fornitori = data;
                });
        }

        document.getElementById('fornitore').addEventListener('input', function() {
            const input = this.value.toLowerCase();
            const suggestions = document.getElementById('fornitoreSuggestions');
            suggestions.innerHTML = '';

            if (input.length > 0) {
                const matchedFornitori = fornitori.filter(fornitore => 
                    fornitore.Nome.toLowerCase().includes(input) || 
                    fornitore.Categoria.toLowerCase().includes(input)
                );

                matchedFornitori.forEach(fornitore => {
                    const div = document.createElement('div');
                    div.textContent = `${fornitore.Nome} - ${fornitore.Categoria}`;
                    div.onclick = function() {
                        document.getElementById('fornitore').value = fornitore.Nome;
                        document.getElementById('fornitore_id').value = fornitore.id;
                        suggestions.innerHTML = '';
                        suggestions.style.display = 'none'; // Hide suggestions after selection
                        addSupplier(fornitore);
                    };
                    suggestions.appendChild(div);
                });
            }

            const rect = this.getBoundingClientRect();
            suggestions.style.top = (rect.bottom + window.scrollY) + 'px';
            suggestions.style.left = (rect.left + window.scrollX) + 'px';
            suggestions.style.width = rect.width + 'px';
            suggestions.style.display = 'block'; // Show suggestions
        });

        window.addEventListener('scroll', () => {
            const input = document.getElementById('fornitore');
            const suggestions = document.getElementById('fornitoreSuggestions');
            if (suggestions.style.display === 'block') {
                const rect = input.getBoundingClientRect();
                suggestions.style.top = (rect.bottom + window.scrollY) + 'px';
                suggestions.style.left = (rect.left + window.scrollX) + 'px';
            }
        });

        async function addSupplier(fornitore) {
            if (!selectedFornitori.some(f => f.id === fornitore.id)) {
            const fornitoreDetails = await caricaDettagliFornitore(fornitore.id);
            if (fornitoreDetails) {
                if (fornitore.confermato !== undefined) {
                fornitoreDetails.confermato = fornitore.confermato;
                }
                selectedFornitori.push(fornitoreDetails);
                updateSupplierList();
                document.getElementById('fornitore').value = ''; // Svuota il campo di testo
            }
            }
        }

        function removeSupplier(fornitoreId) {
            pendingSupplierId = fornitoreId;
            document.getElementById('supplierConfirmationModal').style.display = 'block';
        }
        
        function confirmSupplierDelete() {
            // Remove the supplier and update the list
            selectedFornitori = selectedFornitori.filter(f => f.id !== pendingSupplierId);
            updateSupplierList();
            document.getElementById('supplierConfirmationModal').style.display = 'none';
            pendingSupplierId = null;
        }
        
        function cancelSupplierDelete() {
            document.getElementById('supplierConfirmationModal').style.display = 'none';
            pendingSupplierId = null;
        }



        function updateSupplierList() {
            const supplierList = document.getElementById('current-suppliers');
            supplierList.innerHTML = '';
            selectedFornitori.forEach(fornitore => {
                const div = document.createElement('div');
                
                div.classList.add('supplier-item');
                div.innerHTML = `
                    <h3>${fornitore.descrizione}</h3>
                    ${fornitore.cellulari ? `<p><strong>Cellulari:</strong> ${fornitore.cellulari}</p>` : ''}
                    ${fornitore.numero_dipendenti ? `<p><strong>Numero Dipendenti:</strong> ${fornitore.numero_dipendenti}</p>` : ''}
                    ${fornitore.sito_web ? `<p><strong>Sito Web:</strong> ${fornitore.sito_web}</p>` : ''}
                    ${fornitore.email ? `<p><strong>Email:</strong> ${fornitore.email}</p>` : ''}
                    ${fornitore.partita_iva ? `<p><strong>Partita IVA:</strong> ${fornitore.partita_iva}</p>` : ''}
                    ${fornitore.specialita ? `<p><strong>Specialità:</strong> ${fornitore.specialita}</p>` : ''}
                    ${fornitore.luogo ? `<p><strong>Luogo:</strong> ${fornitore.luogo}</p>` : ''}
                    ${fornitore.categoria ? `<p><strong>Categoria:</strong> ${fornitore.categoria}</p>` : ''}

                    <button class="remove-supplier" onclick="removeSupplier(${fornitore.id})">
                                                    ×
                    </button>
                `;
                supplierList.appendChild(div);
            });
        }

        async function caricaDettagliFornitore(fornitoreId) {
            try {
                const response = await fetch(`/fornitore/${fornitoreId}/`);
                if (!response.ok) throw new Error('Errore durante il caricamento dei dettagli del fornitore.');

                const fornitore = await response.json();
                return fornitore;
            } catch (error) {
                console.error('Errore durante il caricamento dei dettagli del fornitore:', error);
                return null;
            }
        }

        window.onload = async function () {
            try {
                workData = JSON.parse(decodeURIComponent('{{ work_json|escapejs }}'));
                console.log('workData:', workData);
                // Popola i campi principali
                document.getElementById('descrizione').value = workData.descrizione || '';
                if (workData.importo !== undefined && workData.importo !== null) {
                    document.getElementById('importo').value = workData.importo;
                } else {
                    document.getElementById('importo').value = '';
                }

                document.getElementById('fase').value = workData.fase || '';
                document.getElementById('note').value = workData.note || '';

                // Gestione cliente
                await caricaDettagliCliente(workData.cliente_id);

                // Gestione fornitori
                if (workData.fornitori) {
                    for (const fornitore of workData.fornitori) {
                        const fornitoreDetails = await caricaDettagliFornitore(fornitore.id);
                        console.log(fornitore.confermato);
                        if (fornitoreDetails) {
                            addSupplier({ ...fornitoreDetails, confermato: fornitore.confermato });
                        }
                    }
                }

                // Gestione riferimento
                console.log('workData.riferimento_id:', workData.riferimento_id);
                if (workData.riferimento_id) {
                    console.log('Caricando riferimento esistente...');
                    await caricaDettagliRiferimento(workData.riferimento_id);
                    document.getElementById('riferimento-info').style.display = 'block';
                    document.getElementById('no-riferimento-info').style.display = 'none';
                } else {
                    console.log('Nessun riferimento - mostrando pulsante aggiungi');
                    document.getElementById('riferimento-info').style.display = 'none';
                    document.getElementById('no-riferimento-info').style.display = 'block';
                }

                // Caricamento commenti
                await caricaCommenti();
            } catch (error) {
                console.error('Errore durante il caricamento dei dati:', error);
            }
        };

        async function caricaDettagliCliente(clienteId) {
            try {
                const response = await fetch(`/cliente/${clienteId}/`);
                if (!response.ok) throw new Error('Errore durante il caricamento dei dettagli del cliente.');

                const cliente = await response.json();
                updateClientDisplay(cliente);
                
                // Gestione riferimento del cliente se non esiste già un riferimento per il lavoro
                if (cliente.id_riferimento && !workData.riferimento_id) {
                    await caricaDettagliRiferimento(cliente.id_riferimento);
                }
            } catch (error) {
                console.error('Errore durante il caricamento dei dettagli del cliente:', error);
            }
        }

        async function caricaDettagliRiferimento(riferimentoId) {
            try {
                const response = await fetch(`/riferimento/${riferimentoId}/`);
                if (!response.ok) throw new Error('Errore durante il caricamento dei dettagli del riferimento.');

                const riferimento = await response.json();
                updateRiferimentoDisplay(riferimento);
            } catch (error) {
                console.error('Errore durante il caricamento dei dettagli del riferimento:', error);
                updateRiferimentoDisplay(null);
            }
        }
        

        async function caricaCommenti() {
            const commentiList = document.getElementById('commenti-list');
            commentiList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;"><div style="font-size: 24px; margin-bottom: 8px;">💬</div><p>Caricamento chat...</p></div>';

            try {
                const response = await fetch(`/get_comments/?work_id=${workData.id}`);
                if (!response.ok) throw new Error('Errore durante il caricamento dei commenti.');

                const data = await response.json();
                
                // Pulisci la lista
                commentiList.innerHTML = '';
                
                if (data.comments.length === 0) {
                    // Mostra messaggio di benvenuto se non ci sono commenti
                    commentiList.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px 20px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">💬</div>
                            <h3 style="margin-bottom: 8px; color: #333;">Inizia una conversazione</h3>
                            <p style="font-size: 14px; line-height: 1.4;">Scrivi il tuo primo messaggio o carica un file per iniziare la chat su questo ticket.</p>
                        </div>
                    `;
                    return;
                }
                
                data.comments.forEach(comment => {
                    const commentoDiv = document.createElement('div');
                    commentoDiv.classList.add('comment');
                    const isSystemComment = comment.content.startsWith('|system|{');
                    const isImage = comment.attachment && comment.attachment.match(/\.(jpeg|jpg|png|gif)$/i);
                    const isPDF = comment.attachment && comment.attachment.match(/\.pdf$/i);
                    
                    // Costruisci l'URL correttamente
                    let fileUrl = '';
                    if (comment.attachment) {
                        // Separa il percorso base e il parametro file
                        const [basePath, fileName] = comment.attachment.split('?file=');
                        // Codifica solo il nome del file, mantenendo la struttura della query
                        if (fileName) {
                            fileUrl = `${basePath}?file=${encodeURIComponent(fileName)}`;
                        } else {
                            fileUrl = encodeURIComponent(comment.attachment);
                        }
                    }
                    
                    commentoDiv.innerHTML = `
                        <p class="${isSystemComment ? 'system-comment' : ''}">${isSystemComment ? comment.content.replace('|system|{', '').slice(0, -1) : comment.content}</p>
                        ${comment.attachment ? (isImage ? `<img src="/${fileUrl}" alt="Allegato" onclick="showFullscreen('/${fileUrl.replace(/'/g, "\\'")}')">` : 
                        isPDF ? `<div class="pdf-preview" onclick="showPDF('/${fileUrl.replace(/'/g, "\\'")}')"></div>` : 
                        `<a href="/${fileUrl}" target="_blank">Allegato</a>`) : ''}
                        <small>${comment.timestamp}</small>
                        ${!isSystemComment ? `
                        <button class="delete-comment" onclick="deleteComment(${comment.id})">
                            ×
                        </button>` : ''}
                    `;

                    commentiList.appendChild(commentoDiv);

                    if (isPDF) {
                        renderPDFPreview(`/${fileUrl}`, commentoDiv.querySelector('.pdf-preview'));
                    }
                });

                // Scroll to bottom after loading comments
                commentiList.scrollTop = commentiList.scrollHeight;
            } catch (error) {
                console.error('Errore durante il caricamento dei commenti:', error);
                commentiList.innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                        <h3 style="margin-bottom: 8px; color: #dc3545;">Errore nel caricamento</h3>
                        <p style="font-size: 14px; line-height: 1.4; color: #666;">Non è stato possibile caricare i messaggi. Riprova più tardi.</p>
                        <button onclick="caricaCommenti()" style="margin-top: 16px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">Riprova</button>
                    </div>
                `;
            }
        }

        async function renderPDFPreview(url, container) {
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            const page = await pdf.getPage(1);
            
            // Calcola il nuovo scale in base alla larghezza del container e altezza massima di 420px
            const containerWidth = container.clientWidth;
            const desiredMaxHeight = 420;
            const initialViewport = page.getViewport({ scale: 1 });
            const widthScale = containerWidth / initialViewport.width;
            const heightScale = desiredMaxHeight / initialViewport.height;
            const scale = Math.min(widthScale, heightScale);
            const viewport = page.getViewport({ scale: scale });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.maxHeight = desiredMaxHeight + 'px';
            
            await page.render({ canvasContext: context, viewport: viewport }).promise;
            container.innerHTML = ''; // Rimuove eventuali contenuti precedenti
            container.appendChild(canvas);
        }

        function showPDF(url) {
            // Rileva se è un dispositivo mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // Su mobile, apri il PDF direttamente in una nuova scheda
                window.open(url, '_blank');
            } else {
                // Su desktop, mantieni il comportamento esistente con il viewer in-page
                const pdfViewer = document.createElement('div');
                pdfViewer.style.position = 'fixed';
                pdfViewer.style.top = '0';
                pdfViewer.style.left = '0';
                pdfViewer.style.width = '100%';
                pdfViewer.style.height = '100%';
                pdfViewer.style.backgroundColor = 'rgba(0,0,0,0.9)';
                pdfViewer.style.display = 'flex';
                pdfViewer.style.justifyContent = 'center';
                pdfViewer.style.alignItems = 'center';
                pdfViewer.style.zIndex = '1000';

                const iframe = document.createElement('iframe');
                iframe.src = url;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';

                const controls = document.createElement('div');
                controls.className = 'pdf-viewer-controls';

                const backButton = document.createElement('button');
                backButton.className = 'pdf-viewer-button';
                backButton.innerHTML = 'indietro';
                backButton.onclick = () => document.body.removeChild(pdfViewer);

                const downloadButton = document.createElement('a');
                downloadButton.className = 'pdf-viewer-button';
                downloadButton.innerHTML = 'scarica';
                downloadButton.href = url;
                downloadButton.download = '';
                downloadButton.target = '_blank';

                controls.appendChild(backButton);
                controls.appendChild(downloadButton);

                pdfViewer.appendChild(iframe);
                pdfViewer.appendChild(controls);
                document.body.appendChild(pdfViewer);
            }
        }

        // Funzione per aggiornare lo stato del pulsante di invio
        function updateSendButton() {
            const commento = document.getElementById('nuovo-commento').value;
            const fileInput = document.getElementById('file-commento');
            const sendButton = document.getElementById('send-button');
            const files = fileInput ? fileInput.files : [];
            
            const hasContent = commento.trim() !== '' || files.length > 0;
            sendButton.disabled = !hasContent;
        }
        
        // Funzione per mostrare la lista dei file selezionati
        function showFileList(files) {
            const fileList = document.getElementById('file-list');
            if (!fileList) return;
            
            fileList.innerHTML = '';
            
            if (files.length === 0) return;
            
            const fileListHTML = Array.from(files).map((file, index) => {
                const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                const fileName = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 4px; font-size: 13px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 16px;">📎</span>
                            <div>
                                <div style="font-weight: 500; color: #333;">${fileName}</div>
                                <div style="color: #666; font-size: 11px;">${fileSize}</div>
                            </div>
                        </div>
                        <button onclick="removeFile(${index})" style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 2px; font-size: 14px; font-weight: bold;">×</button>
                    </div>
                `;
            }).join('');
            
            fileList.innerHTML = fileListHTML;
        }
        
        // Funzione per rimuovere un file dalla selezione
        function removeFile(index) {
            const fileInput = document.getElementById('file-commento');
            const dt = new DataTransfer();
            
            Array.from(fileInput.files).forEach((file, i) => {
                if (i !== index) dt.items.add(file);
            });
            
            fileInput.files = dt.files;
            updateSendButton();
            showFileList(fileInput.files);
        }

        async function aggiungiCommento() {
            const commento = document.getElementById('nuovo-commento').value;
            const fileInput = document.getElementById('file-commento');
            const files = fileInput.files;

            if (commento.trim() === '' && files.length === 0) return;

            try {
                // Add preview comment immediately
                if (files.length > 0) {
                    const previewComment = document.createElement('div');
                    previewComment.classList.add('comment', 'preview-comment');
                    previewComment.innerHTML = `
                        <p>${commento || 'Caricamento file...'}</p>
                        <small>${new Date().toLocaleString()}</small>
                    `;
                    document.getElementById('commenti-list').appendChild(previewComment);
                    document.getElementById('commenti-list').scrollTop = document.getElementById('commenti-list').scrollHeight;
                }

                // Show loading bar if there are files
                if (files.length > 0) {
                    showLoadingBar();
                }

                // Send the first comment with the first attachment (if any)
                const firstAttachment = files.length > 0 ? await uploadFile(files[0]) : null;
                await sendComment(commento, firstAttachment);

                // Send additional comments for remaining attachments
                for (let i = 1; i < files.length; i++) {
                    updateLoadingBar((i / files.length) * 100);
                    const attachmentUrl = await uploadFile(files[i]);
                    await sendComment('', attachmentUrl);
                }

                // Clear input fields and file list
                document.getElementById('nuovo-commento').value = '';
                fileInput.value = '';
                document.getElementById('file-list').innerHTML = '';
                
                // Reset textarea height
                document.getElementById('nuovo-commento').style.height = '';
                
                // Update send button state
                updateSendButton();

                // Hide loading bar
                hideLoadingBar();

                // Reload comments
                await caricaCommenti();
            } catch (error) {
                console.error('Errore durante l\'aggiunta del commento:', error);
                alert('Si è verificato un errore durante l\'aggiunta del commento.');
                hideLoadingBar();
            }
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/upload_attachment/", true);

                xhr.upload.addEventListener("progress", (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        updateLoadingBar(percent);
                    }
                });

                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            resolve(data.file_url);
                        } else {
                            reject(`Errore upload file: ${xhr.status}`);
                        }
                    }
                };
                xhr.send(formData);
            });
        }

        async function sendComment(content, attachment) {
            try {
                const response = await fetch('/add_comment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        work_id: workData.id,
                        content: content,
                        attachment: attachment
                    }),
                });

                if (!response.ok) {
                    throw new Error('Errore durante l\'aggiunta del commento.');
                }
            } catch (error) {
                console.error('Errore durante l\'invio del commento:', error);
                throw error;
            }
        }

        // Add global variable for pending comment deletion
        let pendingCommentId = null;
		
        // Update deleteComment function to use the custom confirmation modal
        function deleteComment(commentId) {
            pendingCommentId = commentId;
            document.getElementById('confirmationModal').style.display = 'block';
        }
		
        async function confirmDelete() {
            const commentId = pendingCommentId;
            document.getElementById('confirmationModal').style.display = 'none';
            if (!commentId) return;
            try {
                const response = await fetch('/delete_comment/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        comment_id: commentId
                    }),
                });
                if (response.ok) {
                    await caricaCommenti();
                } else {
                    const errorData = await response.json();
                    console.error('Errore durante l\'eliminazione del commento:', errorData.message);
                    alert('Si è verificato un errore: ' + errorData.message);
                }
            } catch (error) {
                console.error('Errore durante l\'eliminazione del commento:', error);
                alert('Si è verificato un errore durante l\'eliminazione del commento.');
            }
            pendingCommentId = null;
        }
		
        function cancelDelete() {
            document.getElementById('confirmationModal').style.display = 'none';
            pendingCommentId = null;
        }

        document.getElementById('nuovo-commento').addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Impedisce di andare a capo
                aggiungiCommento(); // Chiama la funzione per aggiungere il commento
            }
        });

        document.getElementById('work-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const descrizione = document.getElementById('descrizione').value;
            const importo = document.getElementById('importo').value;
            const newFase = document.getElementById('fase').value;
            const note = document.getElementById('note').value;
            
            // Se la fase è stata modificata, aggiungi un commento system
            if(newFase !== workData.fase) {
                const systemComment = `|system|{Fase modificata da ${workData.fase} a ${newFase}}`;
                await fetch('/add_comment/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        work_id: workData.id,
                        content: systemComment,
                        attachment: null
                    })
                });
            }
            
            // Crea un oggetto con i dati del lavoro
            const workDataToSend = {
                id: workData.id,
                descrizione,
                importo,
                fase: newFase,
                note,
                fornitori: selectedFornitori.map(f => ({
                    id: f.id,
                    confermato: f.confermato
                }))
            };

            try {
                const response = await fetch('/update_work/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workDataToSend),
                });

                if (response.ok) {
                    // Aggiungi alla cronologia globale per le modifiche al ticket
                    if (window.parent && window.parent.addToGlobalHistory) {
                        let changes = [];
                        if (descrizione !== workData.descrizione) changes.push('descrizione');
                        if (parseFloat(importo) !== parseFloat(workData.importo)) changes.push('importo');
                        if (newFase !== workData.fase) changes.push('fase');
                        if (note !== workData.note) changes.push('note');
                        
                        if (changes.length > 0) {
                            window.parent.addToGlobalHistory('ticket', 'update', 
                                `Ticket #${workData.numero_ticket} modificato: ${changes.join(', ')}`, 
                                workData.id
                            );
                        }
                    }

                    if (window.parent) {
                        window.parent.closeIframeFromChild();
                    } else {
                        window.close();
                    }
                } else {
                    throw new Error('Errore durante il salvataggio.');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il salvataggio.');
            }
        });

        function showFullscreen(src) {
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.style.position = 'fixed';
            fullscreenDiv.style.top = '0';
            fullscreenDiv.style.left = '0';
            fullscreenDiv.style.width = '100%';
            fullscreenDiv.style.height = '100%';
            fullscreenDiv.style.backgroundColor = 'rgba(0,0,0,0.9)';
            fullscreenDiv.style.display = 'flex';
            fullscreenDiv.style.justifyContent = 'center';
            fullscreenDiv.style.alignItems = 'center';
            fullscreenDiv.style.zIndex = '1000';

            const img = document.createElement('img');
            img.src = src;
            img.style.maxWidth = '90%';
            img.style.maxHeight = '90%';
            img.style.objectFit = 'contain';

            fullscreenDiv.appendChild(img);
            fullscreenDiv.onclick = () => document.body.removeChild(fullscreenDiv);
            document.body.appendChild(fullscreenDiv);
        }

        // Updated drag and drop functionality
        const dropZone = document.querySelector('.comments');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('drop', handleDrop, false);

        async function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            const items = dt.items;

            // Handle files
            if (files.length > 0) {
                document.getElementById('file-commento').files = files;
                updateFileList(files);
                return;
            }

            // Handle dragged images
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    // Get image from clipboard
                    const blob = await items[i].getAsFile();
                    if (!blob) continue;

                    // Generate a unique filename
                    const timestamp = new Date().getTime();
                    const filename = `dragged_image_${timestamp}.png`;
                    const file = new File([blob], filename, { type: 'image/png' });

                    // Create a FormData and upload
                    const formData = new FormData();
                    formData.append('file', file);

                    try {
                        const response = await fetch('/upload_attachment/', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data.status === 'success') {
                            // Add comment with the uploaded image
                            await sendComment('Immagine caricata', data.file_url);
                            await caricaCommenti();
                        }
                    } catch (error) {
                        console.error('Errore durante il caricamento dell\'immagine:', error);
                    }
                }
            }
        }

        // Add auto-resize functionality for textarea
        document.getElementById('nuovo-commento').addEventListener('input', function() {
            this.style.height = '';
            this.style.height = this.scrollHeight + 'px';
        });

        document.getElementById('foto-commento').addEventListener('change', function () {
            const file = this.files[0];
            if (file) {
                // Crea un FormData per caricare il file
                const formData = new FormData();
                formData.append('file', file);

                // Esegui il caricamento del file tramite fetch
                fetch('/upload_attachment/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Aggiungi il commento con l'allegato
                        const attachmentUrl = data.file_url;
                        aggiungiCommentoConAllegato(attachmentUrl);
                    } else {
                        alert('Errore durante il caricamento della foto.');
                    }
                })
                .catch(error => {
                    console.error('Errore durante il caricamento della foto:', error);
                });
            }
        });

        function aggiungiCommentoConAllegato(attachmentUrl) {
            const commento = document.getElementById('nuovo-commento').value;

            fetch('/add_comment/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    work_id: workData.id,
                    content: commento || 'Foto caricata',
                    attachment: attachmentUrl
                }),
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('nuovo-commento').value = '';
                    document.getElementById('foto-commento').value = '';
                    caricaCommenti(); // Ricarica i commenti
                } else {
                    alert('Errore durante l\'invio del commento con foto.');
                }
            });
        }

        document.getElementById('file-commento').addEventListener('change', function() {
            updateFileList(this.files);
        });

        function updateFileList(files) {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const p = document.createElement('p');
                    p.textContent = `File selezionato: ${files[i].name}`;
                    const progress = document.createElement('span');
                    progress.classList.add('upload-progress');
                    p.appendChild(progress);
                    fileList.appendChild(p);
                }
            }
        }

        function consigliaFornitori() {
            document.getElementById('popup-overlay').style.display = 'flex';
        }

        function continuaConsigliaFornitori() {
            const notes = document.getElementById('popup-notes').value;
            const workId = workData.id;
            window.location.href = `/consiglia_fornitori?work_id=${workId}&note=${encodeURIComponent(notes)}`;
        }

        function chiudiPopup() {
            document.getElementById('popup-overlay').style.display = 'none';
        }

        function showEditRiferimentoModal() {
            document.getElementById('editRiferimentoModal').style.display = 'flex';
            // Populate the form with existing reference details
            const riferimentoDetails = document.getElementById('riferimento-details').querySelectorAll('p');
            riferimentoDetails.forEach(detail => {
                const [label, value] = detail.textContent.split(': ');
                switch (label) {
                    case 'Nome':
                        document.getElementById('edit-riferimento-nome').value = value;
                        break;
                    case 'Cognome':
                        document.getElementById('edit-riferimento-cognome').value = value;
                        break;
                    case 'Telefono':
                        document.getElementById('edit-riferimento-telefono').value = value;
                        break;
                    case 'Email':
                        document.getElementById('edit-riferimento-email').value = value;
                        break;
                }
            });
        }

        function closeEditRiferimentoModal() {
            document.getElementById('editRiferimentoModal').style.display = 'none';
        }

        document.getElementById('edit-riferimento-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('edit-riferimento-nome').value;
            const cognome = document.getElementById('edit-riferimento-cognome').value;
            const telefono = document.getElementById('edit-riferimento-telefono').value;
            const email = document.getElementById('edit-riferimento-email').value;
            const riferimentoId = workData.riferimento_id;

            try {
                const response = await fetch(`/update_riferimento/${riferimentoId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nome, cognome, telefono, email }),
                });

                if (response.ok) {
                    closeEditRiferimentoModal();
                    await caricaDettagliRiferimento(riferimentoId);
                } else {
                    throw new Error('Errore durante il salvataggio.');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il salvataggio.');
            }
        });

        function showEditClientModal() {
            document.getElementById('editClientModal').style.display = 'flex';
            // Populate the form with existing client details
            const clientDetails = document.getElementById('client-info').querySelectorAll('p');
            clientDetails.forEach(detail => {
                const [label, value] = detail.textContent.split(': ');
                switch (label) {
                    case 'Descrizione':
                        document.getElementById('edit-client-descrizione').value = value;
                        break;
                    case 'Nome':
                        document.getElementById('edit-client-nome').value = value;
                        break;
                    case 'Cognome':
                        document.getElementById('edit-client-cognome').value = value;
                        break;
                    case 'Email':
                        document.getElementById('edit-client-email').value = value;
                        break;
                    case 'Cellulare':
                        document.getElementById('edit-client-cellulare').value = value;
                        break;
                    case 'Indirizzo':
                        document.getElementById('edit-client-indirizzo').value = value;
                        break;
                    case 'Codice Fiscale':
                        document.getElementById('edit-client-codice_fiscale').value = value;
                        break;
                    case 'P.IVA':
                        document.getElementById('edit-client-piva').value = value;
                        break;
                }
            });
        }

        function closeEditClientModal() {
            document.getElementById('editClientModal').style.display = 'none';
        }

        document.getElementById('edit-client-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const descrizione = document.getElementById('edit-client-descrizione').value;
            const nome = document.getElementById('edit-client-nome').value;
            const cognome = document.getElementById('edit-client-cognome').value;
            const email = document.getElementById('edit-client-email').value;
            const cellulare = document.getElementById('edit-client-cellulare').value;
            const indirizzo = document.getElementById('edit-client-indirizzo').value;
            const codice_fiscale = document.getElementById('edit-client-codice_fiscale').value;
            const piva = document.getElementById('edit-client-piva').value;
            const clienteId = workData.cliente_id;

            try {
                const response = await fetch(`/update_cliente/${clienteId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ descrizione, nome, cognome, email, cellulare, indirizzo, codice_fiscale, piva }),
                });

                if (response.ok) {
                    closeEditClientModal();
                    await caricaDettagliCliente(clienteId);
                } else {
                    throw new Error('Errore durante il salvataggio.');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il salvataggio.');
            }
        });

        function toggleCameraOptions() {
            const cameraOptions = document.getElementById('camera-options');
            cameraOptions.style.display = cameraOptions.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener('click', function(event) {
            const cameraOptions = document.getElementById('camera-options');
            if (!cameraOptions.contains(event.target) && event.target.closest('button') !== cameraOptions.previousElementSibling) {
                cameraOptions.style.display = 'none';
            }
        });

        function showLoadingBar() {
            const container = document.querySelector('.loading-bar-container');
            const bar = document.querySelector('.loading-bar');
            container.style.display = 'block';
            bar.style.width = '0%';
        }

        function updateLoadingBar(progress) {
            const bar = document.querySelector('.loading-bar');
            bar.style.width = `${progress}%`;
        }

        function hideLoadingBar() {
            const container = document.querySelector('.loading-bar-container');
            container.style.display = 'none';
        }

        // Add paste event listener to the comment textarea
        document.getElementById('nuovo-commento').addEventListener('paste', async function(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].kind === 'file') {
                    e.preventDefault();
                    
                    // Show loading bar
                    showLoadingBar();
                    
                    // Get file from clipboard
                    const blob = items[i].getAsFile();
                    
                    // Generate a unique filename based on file type
                    const timestamp = new Date().getTime();
                    let filename;
                    let fileType = blob.type || 'application/octet-stream';
                    
                    // Determina l'estensione del file in base al tipo MIME
                    let extension = 'bin';
                    if (fileType.startsWith('image/')) {
                        extension = fileType.split('/')[1] || 'png';
                        filename = `immagine_incollata_${timestamp}.${extension}`;
                    } else if (fileType === 'application/pdf') {
                        extension = 'pdf';
                        filename = `documento_incollato_${timestamp}.pdf`;
                    } else if (fileType.startsWith('text/')) {
                        extension = fileType.split('/')[1] || 'txt';
                        filename = `testo_incollato_${timestamp}.${extension}`;
                    } else if (fileType.includes('word')) {
                        filename = `documento_incollato_${timestamp}.docx`;
                    } else if (fileType.includes('excel') || fileType.includes('spreadsheet')) {
                        filename = `foglio_calcolo_incollato_${timestamp}.xlsx`;
                    } else {
                        // Per tipi sconosciuti, cerca di mantenere il nome originale del file se disponibile
                        filename = blob.name || `file_incollato_${timestamp}.${extension}`;
                    }
                    
                    const file = new File([blob], filename, { type: fileType });
                    
                    try {
                        // Upload the file
                        const attachmentUrl = await uploadFile(file);
                        
                        // Add the comment with the file
                        let commentText = this.value || `File incollato: ${filename}`;
                        await sendComment(commentText, attachmentUrl);
                        
                        // Clear the textarea
                        this.value = '';
                        this.style.height = '';
                        
                        // Hide loading bar
                        hideLoadingBar();
                        
                        // Reload comments
                        await caricaCommenti();
                    } catch (error) {
                        console.error('Errore durante l\'upload del file incollato:', error);
                        hideLoadingBar();
                        alert('Si è verificato un errore durante il caricamento del file.');
                    }
                    
                    break;
                }
            }
        });

        // Variable to store attachments from comments
        let commentAttachments = [];
        
        function toggleEmailForm() {
            // Mostra popup "presto disponibile" invece del form email
            showPrestoDisponibilePopup();
        }
        
        // Helper function to extract file name from attachment URL
        function getAttachmentFileName(url) {
            if (url.includes('?file=')) {
                // Handle query param format
                const fileName = url.split('?file=')[1];
                return decodeURIComponent(fileName);
            } else {
                // Handle path format
                const parts = url.split('/');
                return parts[parts.length - 1];
            }
        }
        
        async function loadAttachmentsFromComments() {
            try {
                const response = await fetch(`/get_comments/?work_id=${workData.id}`);
                if (!response.ok) throw new Error('Errore durante il caricamento dei commenti.');
                
                const data = await response.json();
                const attachmentsContainer = document.getElementById('email-attachments');
                const toggleButton = document.getElementById('toggle-attachments');
                let allSelected = true; // Start with all selected
                
                commentAttachments = [];
                
                // Filter comments with attachments
                const attachments = data.comments
                    .filter(comment => comment.attachment)
                    .map(comment => ({
                        url: comment.attachment,
                        name: getAttachmentFileName(comment.attachment),
                        date: comment.timestamp,
                        isImage: comment.attachment && comment.attachment.match(/\.(jpeg|jpg|png|gif)$/i),
                        isPDF: comment.attachment && comment.attachment.match(/\.pdf$/i)
                    }));
                
                if (attachments.length === 0) {
                    attachmentsContainer.innerHTML = '<p>Nessun allegato disponibile</p>';
                    toggleButton.style.display = 'none';
                    return;
                }
                
                // Store attachments globally
                commentAttachments = attachments;
                
                // Clear previous content
                attachmentsContainer.innerHTML = '';
                
                // Update toggle button text and functionality
                toggleButton.textContent = 'Deseleziona tutti';
                toggleButton.onclick = function() {
                    const checkboxes = document.querySelectorAll('.attachment-checkbox');
                    if (allSelected) {
                        checkboxes.forEach(cb => cb.checked = false);
                        this.textContent = 'Seleziona tutti';
                    } else {
                        checkboxes.forEach(cb => cb.checked = true);
                        this.textContent = 'Deseleziona tutti';
                    }
                    allSelected = !allSelected;
                    updateAttachmentCount();
                };
                
                // Create attachment list with checkboxes and thumbnails
                commentAttachments.forEach((attachment, index) => {
                    const item = document.createElement('div');
                    item.className = 'attachment-item';
                    
                    // Create thumbnail container
                    const thumbnail = document.createElement('div');
                    thumbnail.className = 'attachment-thumbnail';
                    
                    // Create checkbox (checked by default)
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `attachment-${index}`;
                    checkbox.className = 'attachment-checkbox';
                    checkbox.value = attachment.url;
                    checkbox.checked = true; // Pre-select by default
                    checkbox.addEventListener('change', updateAttachmentCount);
                    
                    // Handle different file types
                    if (attachment.isImage) {
                        // For images, create an img element
                        const img = document.createElement('img');
                        img.src = `/${attachment.url}`;
                        img.alt = attachment.name;
                        img.loading = "lazy"; // Lazy load images
                        thumbnail.appendChild(img);
                    } else if (attachment.isPDF) {
                        // For PDFs, use a PDF icon
                        thumbnail.classList.add('pdf');
                        thumbnail.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <path d="M181.9 256.1c-5.1-9.9-9.8-21.4-13.9-29.8-11.4-23.9-20.7-29.5-30.8-29.5-4 0-8.1.9-11.9 2.8-18.6 9.4-18.6 58.1-18.6 67.1 0 9 1.1 20.3 6.2 30.7 5.2 10.4 13 18.4 24 18.4 10 0 15.5-6 24.2-27.9 4.5-11.2 10-27.1 14.7-36.9l5.1-10.2zM286.2 291c-7.8 0-13.8 6-13.8 13.8v.1c0 7.8 6 13.8 13.8 13.8 7.8 0 14-6 14-13.8 0-7.8-6.2-13.9-14-13.9zM100.4 241.9c-4 0-7.3 3.3-7.3 7.3s3.3 7.3 7.3 7.3c4.1 0 7.3-3.3 7.3-7.3s-3.2-7.3-7.3-7.3zM370.1 224.8c-5.7-4.4-12.8-7-20.4-7-11.4 0-21.4 5.8-27.2 14.7l-2.7-10.5c-1-3.7-4.4-6.5-8.2-6.5H294c-4.7 0-8.6 3.8-8.6 8.6V392c0 4.7 3.8 8.6 8.6 8.6h17.9c4.7 0 8.6-3.8 8.6-8.6v-65.7c0-12 5.9-17.2 13.6-17.2 5.6 0 10 2.4 13.2 5.9 1.6 1.7 3.9 2.7 6.4 2.7 4.7 0 8.6-3.8 8.6-8.6v-35.5c-.2-1.9-1-3.7-2.2-5.1zm-123.1 43c-2.7-.5-5.5-.7-8.3-.7-25.5 0-44.2 14.5-44.2 36.5 0 20.6 16.9 34.9 40.4 34.9 15.3 0 27.8-6 35.1-16.6l1.7 7c.9 3.5 4 6.1 7.8 6.1h14.4c4.7 0 8.6-3.9 8.6-8.6v-97.3c.1-13.9-11.5-24.7-25.1-24.7-8.1 0-16.1 2.5-22.7 7.2l-4.8 3.4C237 216.5 214 208 184 208c-64 0-96 55.5-96 119.8 0 59.5 29.6 118.2 96 118.2 34.9 0 53.4-9.7 64.5-19.8 4.1-3.7 4.7-9.9 1.6-14.5l-10.4-15.2c-3.1-4.5-9.2-5.4-13.5-1.9-3.1 2.5-17.3 14-42.2 14-34.9 0-57.9-34.4-57.9-80.8 0-42.6 19.7-80.8 57.9-80.8 21.4 0 36.8 11.7 36.8 25.9V353c0 4.7 3.8 8.6 8.6 8.6h17.9c4.7 0 8.6-3.8 8.6-8.6v-71.3c0-14.3-9.2-23.2-21.3-24.8z"/>
                            </svg>
                        `;
                    } else {
                        // For other files, use a document icon
                        thumbnail.classList.add('document');
                        thumbnail.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm160-14.1v6.1H256V0h6.1c6.4 0 12.5 2.5 17 7l97.9 98c4.5 4.5 7 10.6 7 16.9z"/>
                            </svg>
                        `;
                    }
                    
                    // Create filename label
                    const name = document.createElement('div');
                    name.className = 'attachment-name';
                    name.title = attachment.name; // Add tooltip with full filename
                    name.textContent = attachment.name;
                    
                    // Create date element
                    const date = document.createElement('div');
                    date.className = 'attachment-date';
                    date.textContent = attachment.date;
                    
                    // Put everything together
                    item.appendChild(checkbox);
                    item.appendChild(thumbnail);
                    item.appendChild(name);
                    item.appendChild(date);
                    
                    attachmentsContainer.appendChild(item);
                });
                
                // Update the initial attachment count
                updateAttachmentCount();
                
            } catch (error) {
                console.error('Errore durante il caricamento degli allegati:', error);
                document.getElementById('email-attachments').innerHTML = 
                    '<p class="error">Errore durante il caricamento degli allegati</p>';
                document.getElementById('toggle-attachments').style.display = 'none';
            }
        }
        
        function updateAttachmentCount() {
            const total = commentAttachments.length;
            const selected = document.querySelectorAll('.attachment-checkbox:checked').length;
            const countElement = document.querySelector('.attachment-count');
            
            if (countElement) {
                countElement.innerHTML = `<strong>${selected}</strong> di ${total} allegati selezionati`;
            }
        }
        
        async function sendEmail() {
            // Get selected attachments
            const selectedAttachments = Array.from(
                document.querySelectorAll('.attachment-checkbox:checked')
            ).map(cb => cb.value);
            
            // Get email data
            const to = document.getElementById('email-to').value;
            const subject = document.getElementById('email-subject').value;
            const body = document.getElementById('email-body').value;
            
            // Validate required fields
            if (!to || !subject) {
                alert('Destinatario e oggetto sono obbligatori.');
                return;
            }
            
            try {
                // Show sending overlay
                const overlay = document.createElement('div');
                overlay.className = 'sending-overlay';
                overlay.innerHTML = `
                    <div class="sending-message">
                        <div class="spinner"></div>
                        <p>Invio email in corso...</p>
                    </div>
                `;
                document.body.appendChild(overlay);
                
                // Send the email
                const response = await fetch('/api/send_email/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: to,
                        subject: subject,
                        body: body,
                        attachments: selectedAttachments
                    })
                });
                
                // Remove overlay
                document.body.removeChild(overlay);
                
                if (response.ok) {
                    const result = await response.json();
                    alert('Email inviata con successo!');
                    toggleEmailForm(); // Close the email form
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Errore durante l\'invio dell\'email');
                }
            } catch (error) {
                alert(`Errore: ${error.message}`);
                console.error('Errore durante l\'invio dell\'email:', error);
                
                // Remove overlay if it exists
                const overlay = document.querySelector('.sending-overlay');
                if (overlay) {
                    document.body.removeChild(overlay);
                }
            }
        }

        function initializeEmailChips() {
            const container = document.querySelector('.email-chips');
            const input = document.getElementById('email-to');
            const suggestionsContainer = document.getElementById('email-suggestions');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            let emails = [];
            let selectedSuggestionIndex = -1;
            let searchTimeout;

            function addEmailChip(email) {
                if (!email) return;
                
                const isValid = emailRegex.test(email);
                const chip = document.createElement('div');
                chip.className = `email-chip ${isValid ? '' : 'invalid-email'}`;
                
                chip.innerHTML = `
                    <span title="${email}">${email}</span>
                    <button type="button" aria-label="Remove email">×</button>
                `;

                chip.querySelector('button').addEventListener('click', () => {
                    chip.remove();
                    emails = emails.filter(e => e !== email);
                });

                container.appendChild(chip);
                emails.push(email);
                input.value = '';
            }

            function showSuggestions() {
                const inputVal = input.value.toLowerCase();
                if (!inputVal) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                let allSuggestions = [];

                // Cerca negli email salvati
                const matchingEmails = savedEmails.filter(email => 
                    email.toLowerCase().includes(inputVal)
                ).map(email => ({
                    type: 'email',
                    display: email,
                    email: email
                }));

                // Cerca nei contatti per nome o email
                const matchingContacts = allContacts.filter(contact => {
                    const nameMatch = contact.name.toLowerCase().includes(inputVal) ||
                                    contact.displayName.toLowerCase().includes(inputVal);
                    const emailMatch = contact.email.toLowerCase().includes(inputVal);
                    return nameMatch || emailMatch;
                }).map(contact => ({
                    type: 'contact',
                    display: `${contact.displayName} <${contact.email}>`,
                    email: contact.email,
                    contactType: contact.type,
                    name: contact.displayName
                }));

                // Combina i risultati, dando priorità ai contatti
                allSuggestions = [...matchingContacts, ...matchingEmails];

                // Rimuovi duplicati basandosi sull'email
                const uniqueSuggestions = [];
                const seenEmails = new Set();
                
                allSuggestions.forEach(suggestion => {
                    if (!seenEmails.has(suggestion.email)) {
                        seenEmails.add(suggestion.email);
                        uniqueSuggestions.push(suggestion);
                    }
                });

                if (uniqueSuggestions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                // Build suggestion HTML
                suggestionsContainer.innerHTML = '';
                uniqueSuggestions.slice(0, 10).forEach((suggestion, index) => { // Limita a 10 suggerimenti
                    const div = document.createElement('div');
                    div.className = 'email-suggestion';
                    
                    if (suggestion.type === 'contact') {
                        div.innerHTML = `
                            <div style="font-weight: bold;">${suggestion.name}</div>
                            <div style="font-size: 0.9em; color: #666;">${suggestion.email} (${suggestion.contactType})</div>
                        `;
                    } else {
                        div.textContent = suggestion.display;
                    }
                    
                    div.dataset.email = suggestion.email;
                    div.addEventListener('click', () => {
                        if (!emails.includes(suggestion.email)) {
                            addEmailChip(suggestion.email);
                        }
                        suggestionsContainer.style.display = 'none';
                    });
                    suggestionsContainer.appendChild(div);
                });

                // Position and show suggestions
                suggestionsContainer.style.display = 'block';
                selectedSuggestionIndex = -1;
            }

            // Debounced input listener
            input.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(showSuggestions, 300); // 300ms delay
            });

            input.addEventListener('keydown', (e) => {
                const suggestions = suggestionsContainer.querySelectorAll('.email-suggestion');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (suggestionsContainer.style.display === 'block') {
                        selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestions.length - 1);
                        highlightSuggestion();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (suggestionsContainer.style.display === 'block') {
                        selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                        highlightSuggestion();
                    }
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (suggestionsContainer.style.display === 'block' && selectedSuggestionIndex >= 0) {
                        const selected = suggestions[selectedSuggestionIndex];
                        if (selected && !emails.includes(selected.dataset.email)) {
                            addEmailChip(selected.dataset.email);
                        }
                        suggestionsContainer.style.display = 'none';
                    } else {
                        const email = input.value.trim().replace(',', '');
                        if (email && !emails.includes(email)) {
                            addEmailChip(email);
                        }
                    }
                } else if (e.key === 'Escape') {
                    suggestionsContainer.style.display = 'none';
                } else if (e.key === ',' || e.key === ' ') {
                    e.preventDefault();
                    const email = input.value.trim().replace(',', '');
                    if (email && !emails.includes(email)) {
                        addEmailChip(email);
                    }
                } else if (e.key === 'Backspace' && input.value === '') {
                    const chips = container.querySelectorAll('.email-chip');
                    if (chips.length > 0) {
                        const lastChip = chips[chips.length - 1];
                        const email = lastChip.querySelector('span').textContent;
                        lastChip.remove();
                        emails = emails.filter(e => e !== email);
                    }
                }
            });

            function highlightSuggestion() {
                const suggestions = suggestionsContainer.querySelectorAll('.email-suggestion');
                suggestions.forEach((s, i) => {
                    if (i === selectedSuggestionIndex) {
                        s.classList.add('selected');
                    } else {
                        s.classList.remove('selected');
                    }
                });
            }

            input.addEventListener('blur', (e) => {
                // Delay hiding suggestions to allow clicking them
                setTimeout(() => {
                    suggestionsContainer.style.display = 'none';
                    
                    const email = input.value.trim().replace(',', '');
                    if (email && !emails.includes(email)) {
                        addEmailChip(email);
                    }
                }, 200);
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!suggestionsContainer.contains(e.target) && e.target !== input) {
                    suggestionsContainer.style.display = 'none';
                }
            });

            // Update the sendEmail function to use the email chips
            window.sendEmail = async function() {
                const selectedAttachments = Array.from(
                    document.querySelectorAll('.attachment-checkbox:checked')
                ).map(cb => cb.value);
                
                const subject = document.getElementById('email-subject').value;
                const body = document.getElementById('email-body').value;
                
                if (emails.length === 0 || !subject) {
                    alert('Destinatario e oggetto sono obbligatori.');
                    return;
                }
                
                try {
                    const overlay = document.createElement('div');
                    overlay.className = 'sending-overlay';
                    overlay.innerHTML = `
                        <div class="sending-message">
                            <div class="spinner"></div>
                            <p>Invio email in corso...</p>
                        </div>
                    `;
                    document.body.appendChild(overlay);
                    
                    const response = await fetch('/api/send_email/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            to: emails,
                            subject: subject,
                            body: body,
                            attachments: selectedAttachments
                        })
                    });
                    
                    document.body.removeChild(overlay);
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // Save all email addresses used in this email
                        emails.forEach(email => addToSavedEmails(email));
                        
                        alert('Email inviata con successo!');
                        toggleEmailForm();
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || 'Errore durante l\'invio dell\'email');
                    }
                } catch (error) {
                    alert(`Errore: ${error.message}`);
                    console.error('Errore durante l\'invio dell\'email:', error);
                    
                    const overlay = document.querySelector('.sending-overlay');
                    if (overlay) {
                        document.body.removeChild(overlay);
                    }
                }
            }
        }

        // Initialize email chips when the email form is shown
        const originalToggleEmailForm = toggleEmailForm;
        toggleEmailForm = function() {
            originalToggleEmailForm();
            if (document.getElementById('email-form').style.display === 'block') {
                initializeEmailChips();
                // Carica tutti i contatti quando si apre il form email
                fetchAllContacts();
            }
        }

        function showAddRiferimentoModal() {
            document.getElementById('addRiferimentoModal').style.display = 'flex';
        }

        function closeAddRiferimentoModal() {
            document.getElementById('addRiferimentoModal').style.display = 'none';
        }

        document.getElementById('add-riferimento-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('add-riferimento-nome').value;
            const cognome = document.getElementById('add-riferimento-cognome').value;
            const telefono = document.getElementById('add-riferimento-telefono').value;
            const email = document.getElementById('add-riferimento-email').value;

            // Verifica che almeno un campo sia compilato
            if (!nome && !cognome && !telefono && !email) {
                alert('Compila almeno un campo per aggiungere il riferimento.');
                return;
            }

            try {
                // Prima crea il nuovo riferimento
                const createResponse = await fetch('/api/add_riferimento/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nome, cognome, telefono, email }),
                });

                if (!createResponse.ok) {
                    throw new Error('Errore durante la creazione del riferimento.');
                }

                const createData = await createResponse.json();
                if (createData.status !== 'success') {
                    throw new Error('Errore durante la creazione del riferimento.');
                }

                const nuovoRiferimentoId = createData.riferimento_id;

                // Poi aggiorna il lavoro con il nuovo riferimento
                const updateResponse = await fetch(`/update_work/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        id: workData.id,
                        riferimento_id: nuovoRiferimentoId,
                        descrizione: workData.descrizione,
                        importo: workData.importo,
                        fase: workData.fase,
                        note: workData.note
                    }),
                });

                if (!updateResponse.ok) {
                    throw new Error('Errore durante l\'aggiornamento del lavoro.');
                }

                // Aggiorna workData con il nuovo riferimento_id
                workData.riferimento_id = nuovoRiferimentoId;

                // Chiudi il modal e aggiorna l'interfaccia
                closeAddRiferimentoModal();
                await caricaDettagliRiferimento(nuovoRiferimentoId);
                document.getElementById('riferimento-info').style.display = 'block';
                document.getElementById('no-riferimento-info').style.display = 'none';

                // Pulisci i campi del form
                document.getElementById('add-riferimento-form').reset();

                alert('Riferimento aggiunto con successo!');
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante l\'aggiunta del riferimento.');
            }
        });

        async function removeRiferimento() {
            if (!confirm('Sei sicuro di voler rimuovere il riferimento da questo lavoro?')) {
                return;
            }

            try {
                const response = await fetch('/update_work/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        id: workData.id,
                        riferimento_id: null,
                        descrizione: workData.descrizione,
                        importo: workData.importo,
                        fase: workData.fase,
                        note: workData.note
                    }),
                });

                if (!response.ok) {
                    throw new Error('Errore durante la rimozione del riferimento.');
                }

                // Aggiorna workData
                workData.riferimento_id = null;

                // Aggiorna l'interfaccia
                document.getElementById('riferimento-info').style.display = 'none';
                document.getElementById('no-riferimento-info').style.display = 'block';

                alert('Riferimento rimosso con successo!');
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante la rimozione del riferimento.');
            }
        }

        // Fetch saved emails when the page loads
        fetchSavedEmails();

        // Funzione per caricare tutti i contatti
        async function fetchAllContacts() {
            try {
                // Carica clienti
                const clientsResponse = await fetch('/get_clients/');
                const clients = await clientsResponse.json();
                
                // Carica fornitori (se esiste un endpoint per tutti i fornitori)
                const suppliersResponse = await fetch('/api/fornitori');
                const suppliers = await suppliersResponse.json();
                
                // Costruisci l'array dei contatti
                allContacts = [];
                
                // Aggiungi clienti
                clients.forEach(client => {
                    if (client.email) {
                        allContacts.push({
                            type: 'Cliente',
                            name: client.nome && client.cognome ? `${client.nome} ${client.cognome}` : client.descrizione,
                            email: client.email,
                            displayName: client.descrizione || `${client.nome} ${client.cognome}`.trim()
                        });
                    }
                });
                
                // Aggiungi fornitori
                suppliers.forEach(supplier => {
                    if (supplier.email) {
                        // Gestisce diversi formati di fornitori
                        let displayName = '';
                        let contactName = '';
                        
                        if (supplier.Nome) {
                            // Formato con Nome maiuscolo (come da API fornitori)
                            displayName = supplier.Nome;
                            contactName = supplier.Nome;
                        } else if (supplier.descrizione) {
                            displayName = supplier.descrizione;
                            contactName = supplier.descrizione;
                        } else if (supplier.nome && supplier.cognome) {
                            displayName = `${supplier.nome} ${supplier.cognome}`;
                            contactName = `${supplier.nome} ${supplier.cognome}`;
                        } else if (supplier.nome) {
                            displayName = supplier.nome;
                            contactName = supplier.nome;
                        } else {
                            displayName = supplier.email;
                            contactName = supplier.email;
                        }
                        
                        allContacts.push({
                            type: 'Fornitore',
                            name: contactName,
                            email: supplier.email,
                            displayName: displayName
                        });
                    }
                });
                
                // Carica riferimenti se il lavoro corrente ha un cliente con riferimenti
                if (workData && workData.cliente_id) {
                    const clientResponse = await fetch(`/cliente/${workData.cliente_id}/`);
                    const client = await clientResponse.json();
                    if (client.id_riferimento) {
                        const refResponse = await fetch(`/riferimento/${client.id_riferimento}/`);
                        const riferimento = await refResponse.json();
                        if (riferimento && riferimento.email) {
                            allContacts.push({
                                type: 'Riferimento',
                                name: `${riferimento.nome} ${riferimento.cognome}`.trim(),
                                email: riferimento.email,
                                displayName: `${riferimento.nome} ${riferimento.cognome}`.trim()
                            });
                        }
                    }
                }
                
                // Aggiungi il riferimento del lavoro se esiste
                if (workData && workData.riferimento_id) {
                    const refResponse = await fetch(`/riferimento/${workData.riferimento_id}/`);
                    const riferimento = await refResponse.json();
                    if (riferimento && riferimento.email) {
                        // Verifica se non è già stato aggiunto
                        const exists = allContacts.some(contact => contact.email === riferimento.email);
                        if (!exists) {
                            allContacts.push({
                                type: 'Riferimento',
                                name: `${riferimento.nome} ${riferimento.cognome}`.trim(),
                                email: riferimento.email,
                                displayName: `${riferimento.nome} ${riferimento.cognome}`.trim()
                            });
                        }
                    }
                }
                
                console.log('Contatti caricati:', allContacts);
            } catch (error) {
                console.error('Errore durante il caricamento dei contatti:', error);
            }
        }

        // ====== NUOVE FUNZIONI PER INTERFACCIA TELEFONO ======
        
        // Variabili globali per l'interfaccia telefono
        let currentApp = null;
        let workHistory = [];

        // Funzioni per l'interfaccia telefono
        function updatePhoneTime() {
            // Funzione rimossa - data e ora non più presenti nell'interfaccia
        }

        function openApp(appName) {
            // Gestione specifica per ogni app usando il nuovo sistema
            switch(appName) {
                case 'chat':
                    openChatView();
                    break;
                    
                case 'history':
                    openHistoryView();
                    break;
                    
                case 'files':
                    if (currentView !== 'files') {
                        navigationHistory.push(currentView);
                        showView('files');
                    }
                    break;
                    
                case 'email':
                    openEmailView();
                    break;
                    
                case 'whatsapp':
                    openWhatsAppView();
                    break;
                    
                default:
                    console.log('App non riconosciuta:', appName);
                    break;
            }
        }
        
        // Nuova funzione per gestire l'app email
         async function handleEmailApp() {
             console.log('workData completo:', workData);
             
             if (!workData || !workData.id) {
                 showNoEmailAlert('Dati lavoro non disponibili');
                 return;
             }
             
             try {
                 // Chiamata al nuovo endpoint che restituisce solo i contatti del ticket
                 const response = await fetch(`/api/work/${workData.id}/email-contacts-ticket/`);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                 }
                 
                 const data = await response.json();
                 
                 if (data.status === 'error') {
                     throw new Error(data.message || 'Errore nel recupero contatti');
                 }
                 
                 const contacts = data.contacts || [];
                 console.log('Contatti email trovati:', contacts);
                 
                 if (contacts.length === 0) {
                     showNoEmailAlert('Nessun indirizzo email trovato per questo ticket');
                     return;
                 }
                 
                 if (contacts.length === 1) {
                     // Una sola email trovata, apri direttamente il client email
                     openEmailClient(contacts[0].email, workData);
                 } else {
                     // Multiple email trovate, mostra selettore avanzato
                     showEmailSelectorAdvanced(contacts, workData);
                 }
                 
             } catch (error) {
                 console.error('Errore nel recupero contatti email:', error);
                 showNoEmailAlert('Errore nel recupero dei contatti email: ' + error.message);
             }
         }
        
        // ===== FUNZIONI UTILITY PER EMAIL =====
        
        // Funzione per validare email
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Funzione per chiudere il selettore email
        function closeEmailSelector() {
            const popup = document.getElementById('emailSelectorPopup');
            if (popup) {
                popup.remove();
            }
        }
        
        // Funzione per aprire il client email con messaggio precompilato
        function openEmailClient(email, workData) {
            const ticketNumber = workData.numero_ticket || '';
            const description = workData.descrizione || '';
            
            const subject = encodeURIComponent(`Ticket ${ticketNumber}: ${description}`);
            const body = encodeURIComponent(`Ciao,\n\nTi contatto in merito al ticket ${ticketNumber}: ${description}\n\n`);
            
            const mailtoUrl = `mailto:${email}?subject=${subject}&body=${body}`;
            window.open(mailtoUrl, '_blank');
        }
        
        // Funzione per mostrare il popup "presto disponibile"
        function showPrestoDisponibilePopup() {
            // Crea il popup se non esiste
            let popup = document.getElementById('prestoDisponibilePopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'prestoDisponibilePopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                popup.innerHTML = `
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        text-align: center;
                        position: relative;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                        max-width: 400px;
                        width: 90%;
                    ">
                        <button onclick="closePrestoDisponibilePopup()" style="
                            position: absolute;
                            top: 10px;
                            right: 15px;
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                            line-height: 1;
                        ">×</button>
                        <h2 style="color: #333; margin-bottom: 20px; font-size: 24px;">🚀 Funzionalità in Arrivo</h2>
                        <p style="color: #666; font-size: 16px; line-height: 1.5;">
                            Questa funzionalità sarà presto disponibile!<br>
                            Stiamo lavorando per portarti nuove fantastiche features.
                        </p>
                    </div>
                `;
                
                document.body.appendChild(popup);
                
                // Chiudi popup cliccando sullo sfondo
                popup.onclick = function(e) {
                    if (e.target === popup) {
                        closePrestoDisponibilePopup();
                    }
                };
            }
            
            popup.style.display = 'flex';
        }
        
        // Funzione per chiudere il popup
        function closePrestoDisponibilePopup() {
            const popup = document.getElementById('prestoDisponibilePopup');
            if (popup) {
                popup.remove();
            }
        }

        function closeApp() {
            // Torna alla vista principale
            navigateBack();
        }

        // Funzione per caricare lo storico delle modifiche
        async function loadWorkHistory() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Caricamento storico...</p>';
            
            try {
                // Carica i commenti di sistema che rappresentano le modifiche
                const response = await fetch(`/get_comments/?work_id=${workData.id}`);
                if (!response.ok) throw new Error('Errore durante il caricamento dello storico.');
                
                const data = await response.json();
                const systemComments = data.comments.filter(comment => 
                    comment.content.startsWith('|system|{')
                );
                
                historyList.innerHTML = '';
                
                if (systemComments.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Nessuna modifica registrata</p>';
                    return;
                }
                
                systemComments.forEach(comment => {
                    const content = comment.content.replace('|system|{', '').slice(0, -1);
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    historyItem.innerHTML = `
                        <div class="history-item-header">
                            <span class="history-action">Modifica Sistema</span>
                            <span class="history-date">${comment.timestamp}</span>
                        </div>
                        <div class="history-details">${content}</div>
                    `;
                    
                    historyList.appendChild(historyItem);
                });
                
            } catch (error) {
                console.error('Errore durante il caricamento dello storico:', error);
                historyList.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px;">Errore durante il caricamento</p>';
            }
        }

        // Funzione per caricare i file dal chat
        async function loadWorkFiles() {
            const filesGrid = document.getElementById('files-grid');
            filesGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 20px; grid-column: 1 / -1;">Caricamento file...</p>';
            
            try {
                const response = await fetch(`/get_comments/?work_id=${workData.id}`);
                if (!response.ok) throw new Error('Errore durante il caricamento dei file.');
                
                const data = await response.json();
                const commentsWithFiles = data.comments.filter(comment => 
                    comment.attachment && !comment.content.startsWith('|system|{')
                );
                
                filesGrid.innerHTML = '';
                
                if (commentsWithFiles.length === 0) {
                    filesGrid.innerHTML = '<p style="text-align: center; color: #666; padding: 20px; grid-column: 1 / -1;">Nessun file trovato</p>';
                    return;
                }
                
                commentsWithFiles.forEach(comment => {
                    const isImage = comment.attachment.match(/\.(jpeg|jpg|png|gif)$/i);
                    const isPDF = comment.attachment.match(/\.pdf$/i);
                    
                    // Costruisci l'URL correttamente
                    let fileUrl = '';
                    if (comment.attachment) {
                        const [basePath, fileName] = comment.attachment.split('?file=');
                        if (fileName) {
                            fileUrl = `${basePath}?file=${encodeURIComponent(fileName)}`;
                        } else {
                            fileUrl = encodeURIComponent(comment.attachment);
                        }
                    }
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.onclick = () => openFileViewer(`/${fileUrl}`, isImage, isPDF);
                    
                    let thumbnailContent;
                    if (isImage) {
                        thumbnailContent = `<img src="/${fileUrl}" alt="Immagine" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">`;
                    } else if (isPDF) {
                        thumbnailContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" style="width: 40px; height: 40px; color: #dc3545;"><path d="M181.9 256.1c-5.1-9.9-9.8-21.4-13.9-29.8z"/></svg>`;
                    } else {
                        thumbnailContent = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" style="width: 40px; height: 40px; color: #6c757d;"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24z"/></svg>`;
                    }
                    
                    let fileName = comment.attachment;
                    if (fileName.includes('?file=')) {
                        fileName = decodeURIComponent(fileName.split('?file=')[1]);
                    } else {
                        fileName = fileName.split('/').pop();
                    }
                    
                    fileItem.innerHTML = `
                        <div class="file-thumbnail">${thumbnailContent}</div>
                        <div class="file-name" title="${fileName}">${fileName}</div>
                    `;
                    
                    filesGrid.appendChild(fileItem);
                });
                
            } catch (error) {
                console.error('Errore durante il caricamento dei file:', error);
                filesGrid.innerHTML = '<p style="text-align: center; color: #dc3545; padding: 20px; grid-column: 1 / -1;">Errore durante il caricamento</p>';
            }
        }

        function openFileViewer(url, isImage, isPDF) {
            if (isImage) {
                showFullscreen(url);
            } else if (isPDF) {
                showPDF(url);
            } else {
                window.open(url, '_blank');
            }
        }

        // Inizializza al caricamento
        // updatePhoneTime(); 
        // setInterval(updatePhoneTime, 60000);

        // Funzione per confermare l'eliminazione del ticket
        function confirmDelete() {
            document.getElementById('deleteConfirmationModal').style.display = 'flex';
        }

        // Funzione per confermare lo spostamento del ticket
        function confirmMove() {
            const newStage = document.getElementById('move-to-stage').value;
            // Qui potresti aggiungere il codice per aggiornare la fase del lavoro
            // e salvare le modifiche nel database
            alert('Ticket spostato in fase: ' + newStage);
            closeMoveModal();
        }

        // Funzione per chiudere il modal di conferma eliminazione
        function closeDeleteModal() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
        }

        // Funzione per chiudere il modal di spostamento
        function closeMoveModal() {
            document.getElementById('moveModal').style.display = 'none';
        }

        // ====== FUNZIONI TASTI VELOCI ======
        
        // Mostra modal di conferma eliminazione
        function showDeleteConfirmation() {
            document.getElementById('deleteConfirmationModal').style.display = 'flex';
        }

        // Mostra modal spostamento
        function showMoveModal() {
            // Imposta la fase corrente come selezionata
            const currentStage = document.getElementById('fase').value;
            document.getElementById('move-to-stage').value = currentStage;
            document.getElementById('moveModal').style.display = 'flex';
        }

        // Conferma eliminazione ticket
        async function confirmDelete() {
            try {
                const response = await fetch('/api/delete_work/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        work_id: workData.id
                    })
                });

                if (response.ok) {
                    alert('Ticket eliminato con successo!');
                    if (window.parent) {
                        window.parent.closeIframeFromChild();
                    } else {
                        window.close();
                    }
                } else {
                    throw new Error('Errore durante l\'eliminazione del ticket');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante l\'eliminazione del ticket.');
            }
            closeDeleteModal();
        }

        // Conferma spostamento ticket
        async function confirmMove() {
            const newStage = document.getElementById('move-to-stage').value;
            const currentStage = document.getElementById('fase').value;
            
            if (newStage === currentStage) {
                alert('Il ticket è già in questa fase.');
                closeMoveModal();
                return;
            }

            try {
                // Aggiorna la fase nel form
                document.getElementById('fase').value = newStage;
                
                // Salva automaticamente le modifiche
                const workDataToSend = {
                    id: workData.id,
                    descrizione: document.getElementById('descrizione').value,
                    importo: document.getElementById('importo').value,
                    fase: newStage,
                    note: document.getElementById('note').value,
                    fornitori: selectedFornitori.map(f => ({
                        id: f.id,
                        confermato: f.confermato
                    }))
                };

                const response = await fetch('/update_work/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(workDataToSend),
                });

                if (response.ok) {
                    alert('Ticket spostato con successo!');
                    if (window.parent) {
                        window.parent.closeIframeFromChild();
                    } else {
                        window.close();
                    }
                } else {
                    throw new Error('Errore durante lo spostamento del ticket');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante lo spostamento del ticket.');
            }
            closeMoveModal();
        }

        // Chiude modal eliminazione
        function closeDeleteModal() {
            document.getElementById('deleteConfirmationModal').style.display = 'none';
        }

        // Chiude modal spostamento
        function closeMoveModal() {
            document.getElementById('moveModal').style.display = 'none';
        }

        // ===== FUNZIONI WHATSAPP =====
        
        // Funzione principale per gestire l'app WhatsApp
        async function handleWhatsAppApp() {
            console.log('workData completo:', workData);
            
            if (!workData || !workData.id) {
                showNoWhatsAppAlert('Dati lavoro non disponibili');
                return;
            }
            
            try {
                // Chiamata al nuovo endpoint che restituisce solo i contatti del ticket
                const response = await fetch(`/api/work/${workData.id}/whatsapp-contacts-ticket/`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'error') {
                    throw new Error(data.message || 'Errore nel recupero dei contatti');
                }
                
                console.log('Contatti trovati:', data.contacts);
                
                // Filtra i contatti che hanno numeri di telefono validi per WhatsApp
                const validContacts = [];
                
                for (const contact of data.contacts) {
                    if (contact.phone) {
                        const validNumbers = extractValidCellPhones(contact.phone);
                        if (validNumbers.length > 0) {
                            validContacts.push({
                                ...contact,
                                validNumbers: validNumbers
                            });
                        }
                    }
                }
                
                console.log('Contatti con numeri validi:', validContacts);
                
                if (validContacts.length === 0) {
                    const ticketInfo = data.work_info ? 
                        `per il ticket ${data.work_info.numero_ticket}: "${data.work_info.descrizione}"` : 
                        'per questo ticket';
                    showNoWhatsAppAlert(`Nessun numero WhatsApp valido trovato ${ticketInfo}`);
                    return;
                }
                
                if (validContacts.length === 1 && validContacts[0].validNumbers.length === 1) {
                    // Un solo contatto con un solo numero - apri direttamente WhatsApp
                    const contact = validContacts[0];
                    const message = createWhatsAppMessage(data.work_info);
                    openWhatsAppWithMessage(contact.validNumbers[0], message);
                } else {
                    // Più contatti o numeri - mostra selezione avanzata
                    showWhatsAppSelectorAdvanced(validContacts, data.work_info);
                }
                
            } catch (error) {
                console.error('Errore durante la ricerca contatti WhatsApp:', error);
                showNoWhatsAppAlert(`Errore durante la ricerca dei contatti: ${error.message}`);
            }
        }
        
        // Funzione per creare il messaggio WhatsApp
        function createWhatsAppMessage(workInfo) {
            if (!workInfo) return '';
            
            const ticketNumber = workInfo.numero_ticket;
            const description = workInfo.descrizione || 'Lavoro';
            
            return `Ciao! Ti contatto per il ticket ${ticketNumber}: ${description}`;
        }
        
        // Funzione per aprire WhatsApp con messaggio
        function openWhatsAppWithMessage(phoneNumber, message = '') {
            const normalizedNumber = normalizePhoneForWhatsApp(phoneNumber);
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${normalizedNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Selettore ottimizzato per più contatti
        function showWhatsAppSelectorOptimized(contacts, workInfo) {
            const message = createWhatsAppMessage(workInfo);
            
            let html = `
                <div style="
                    position: fixed; 
                    top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 10000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                ">
                    <div style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 10px; 
                        max-width: 500px; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        position: relative;
                    ">
                        <button onclick="closeWhatsAppSelector()" style="
                            position: sticky;
                            top: 0;
                            right: 0;
                            float: right;
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                            line-height: 1;
                            z-index: 10001;
                            margin-bottom: 10px;
                        ">×</button>
                        <h3 style="margin-bottom: 15px; color: #25D366; clear: both;">
                            📱 Seleziona contatto WhatsApp
                        </h3>
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            ${workInfo ? `Ticket ${workInfo.numero_ticket}: ${workInfo.descrizione}` : 'Seleziona un contatto'}
                        </p>
            `;
            
            contacts.forEach((contact, index) => {
                const contactName = contact.name || 'Contatto senza nome';
                const source = contact.source || contact.type;
                
                if (contact.validNumbers.length === 1) {
                    // Un solo numero per questo contatto
                    html += `
                        <div onclick="selectWhatsAppContact('${contact.validNumbers[0]}', '${encodeURIComponent(message)}')" 
                             style="
                                background: #f8f9fa; 
                                border: 1px solid #e9ecef; 
                                border-radius: 8px; 
                                padding: 12px; 
                                margin-bottom: 10px; 
                                cursor: pointer; 
                                transition: all 0.2s;
                             "
                             onmouseover="this.style.background='#25D366'; this.style.color='white';"
                             onmouseout="this.style.background='#f8f9fa'; this.style.color='black';">
                            <div style="font-weight: bold;">${contactName}</div>
                            <div style="font-size: 12px; opacity: 0.7;">${getSourceLabel(source)}</div>
                            <div style="font-size: 13px;">📱 ${contact.validNumbers[0]}</div>
                        </div>
                    `;
                } else {
                    // Più numeri per questo contatto
                    contact.validNumbers.forEach((number, numIndex) => {
                        html += `
                            <div onclick="selectWhatsAppContact('${number}', '${encodeURIComponent(message)}')" 
                                 style="
                                    background: #f8f9fa; 
                                    border: 1px solid #e9ecef; 
                                    border-radius: 8px; 
                                    padding: 12px; 
                                    margin-bottom: 10px; 
                                    cursor: pointer; 
                                    transition: all 0.2s;
                                 "
                                 onmouseover="this.style.background='#25D366'; this.style.color='white';"
                                 onmouseout="this.style.background='#f8f9fa'; this.style.color='black';">
                                <div style="font-weight: bold;">${contactName} (${numIndex + 1})</div>
                                <div style="font-size: 12px; opacity: 0.7;">${getSourceLabel(source)}</div>
                                <div style="font-size: 13px;">📱 ${number}</div>
                            </div>
                        `;
                    });
                }
            });
            
            html += `
                        <button onclick="closeWhatsAppSelector()" 
                                style="
                                    width: 100%; 
                                    padding: 10px; 
                                    background: #dc3545; 
                                    color: white; 
                                    border: none; 
                                    border-radius: 5px; 
                                    cursor: pointer; 
                                    margin-top: 15px;
                                ">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.id = 'whatsapp-selector-popup';
            popup.innerHTML = html;
            
            // Aggiungi evento per chiudere cliccando fuori
            popup.onclick = function(e) {
                if (e.target === popup) {
                    closeWhatsAppSelector();
                }
            };
            
            document.body.appendChild(popup);
        }
        
        // Funzione per selezionare un contatto WhatsApp
        function selectWhatsAppContact(phoneNumber, encodedMessage) {
            const normalizedNumber = normalizePhoneForWhatsApp(phoneNumber);
            const whatsappUrl = `https://wa.me/${normalizedNumber}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
            closeWhatsAppSelector();
        }
        
        // Selettore avanzato per WhatsApp con raggruppamento
        function showWhatsAppSelectorAdvanced(contacts, workInfo) {
            const message = createWhatsAppMessage(workInfo);
            
            // Raggruppa contatti per tipo
            const grouped = {};
            contacts.forEach(contact => {
                const type = contact.type || 'Altri';
                if (!grouped[type]) {
                    grouped[type] = [];
                }
                grouped[type].push(contact);
            });
            
            let html = `
                <div style="
                    position: fixed; 
                    top: 0; left: 0; right: 0; bottom: 0; 
                    background: rgba(0,0,0,0.5); 
                    z-index: 10000; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                ">
                    <div style="
                        background: white; 
                        padding: 20px; 
                        border-radius: 10px; 
                        max-width: 600px; 
                        max-height: 80vh; 
                        overflow-y: auto;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                        position: relative;
                    ">
                        <button onclick="closeWhatsAppSelector()" style="
                            position: sticky;
                            top: 0;
                            right: 0;
                            float: right;
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                            line-height: 1;
                            z-index: 10001;
                            margin-bottom: 10px;
                        ">×</button>
                        <h3 style="margin-bottom: 15px; color: #25D366; clear: both;">
                            📱 Seleziona contatto WhatsApp
                        </h3>
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            ${workInfo ? `Ticket ${workInfo.numero_ticket}: ${workInfo.descrizione}` : 'Seleziona un contatto'}
                        </p>
            `;
            
            Object.keys(grouped).forEach(type => {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #495057; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;">
                            ${type}
                        </h4>
                `;
                
                grouped[type].forEach((contact, index) => {
                    const contactName = contact.name || 'Contatto senza nome';
                    
                    if (contact.validNumbers.length === 1) {
                        // Un solo numero per questo contatto
                        html += `
                            <div onclick="selectWhatsAppContact('${contact.validNumbers[0]}', '${encodeURIComponent(message)}')" 
                                 style="
                                    background: #f8f9fa; 
                                    border: 1px solid #e9ecef; 
                                    border-radius: 8px; 
                                    padding: 12px; 
                                    margin-bottom: 8px; 
                                    cursor: pointer; 
                                    transition: all 0.2s;
                                 "
                                 onmouseover="this.style.background='#25D366'; this.style.color='white';"
                                 onmouseout="this.style.background='#f8f9fa'; this.style.color='black';">
                                <div style="font-weight: bold;">${contactName}</div>
                                <div style="font-size: 13px;">📱 ${contact.validNumbers[0]}</div>
                            </div>
                        `;
                    } else {
                        // Più numeri per questo contatto
                        contact.validNumbers.forEach((number, numIndex) => {
                            html += `
                                <div onclick="selectWhatsAppContact('${number}', '${encodeURIComponent(message)}')" 
                                     style="
                                        background: #f8f9fa; 
                                        border: 1px solid #e9ecef; 
                                        border-radius: 8px; 
                                        padding: 12px; 
                                        margin-bottom: 8px; 
                                        cursor: pointer; 
                                        transition: all 0.2s;
                                     "
                                     onmouseover="this.style.background='#25D366'; this.style.color='white';"
                                     onmouseout="this.style.background='#f8f9fa'; this.style.color='black';">
                                    <div style="font-weight: bold;">${contactName} (${numIndex + 1})</div>
                                    <div style="font-size: 13px;">📱 ${number}</div>
                                </div>
                            `;
                        });
                    }
                });
                
                html += `</div>`;
            });
            
            html += `
                        <button onclick="closeWhatsAppSelector()" 
                                style="
                                    width: 100%; 
                                    padding: 10px; 
                                    background: #dc3545; 
                                    color: white; 
                                    border: none; 
                                    border-radius: 5px; 
                                    cursor: pointer; 
                                    margin-top: 15px;
                                ">
                            Chiudi
                        </button>
                    </div>
                </div>
            `;
            
            const popup = document.createElement('div');
            popup.id = 'whatsapp-selector-popup';
            popup.innerHTML = html;
            
            // Aggiungi evento per chiudere cliccando fuori
            popup.onclick = function(e) {
                if (e.target === popup) {
                    closeWhatsAppSelector();
                }
            };
            
            document.body.appendChild(popup);
        }
        
        // Funzione per chiudere il selettore
        function closeWhatsAppSelector() {
            const popup = document.getElementById('whatsapp-selector-popup');
            if (popup) {
                popup.remove();
            }
        }

        // Funzione per mostrare selettore email con fonti
        function showEmailSelectorWithSources(emails, workData) {
            let popup = document.getElementById('emailSelectorPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'emailSelectorPopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                document.body.appendChild(popup);
            }
            
            popup.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    text-align: center;
                    position: relative;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    max-width: 600px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <button onclick="closeEmailSelector()" style="
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        line-height: 1;
                    ">×</button>
                    <h2 style="color: #007bff; margin-bottom: 20px; font-size: 24px;">📧 Seleziona Email</h2>
                    <p style="color: #666; font-size: 16px; margin-bottom: 20px;">
                        Sono state trovate più email associate a questo ticket.<br>
                        Seleziona quella a cui vuoi scrivere:
                    </p>
                    <div id="emailButtonsContainer">
                        ${emails.map(emailData => `
                            <button onclick="openEmailClient('${emailData.email.replace(/'/g, "\\'")}', workData); closeEmailSelector();" style="
                                display: block;
                                width: 100%;
                                margin: 10px 0;
                                padding: 15px;
                                background-color: #007bff;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-size: 14px;
                                text-align: left;
                                transition: background-color 0.3s ease;
                            " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                                <div style="font-weight: bold; margin-bottom: 5px;">📧 ${emailData.email}</div>
                                <div style="font-size: 12px; opacity: 0.9;">${getSourceLabel(emailData.source)}: ${emailData.name}</div>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="closeEmailSelector()" style="
                        margin-top: 20px;
                        padding: 10px 20px;
                        background-color: #6c757d;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                    ">Annulla</button>
                </div>
            `;
            
            popup.style.display = 'flex';
        }
        
        // Funzione per mostrare selettore email avanzato con più opzioni
        function showEmailSelectorAdvanced(contacts, workData) {
            let popup = document.getElementById('emailSelectorPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'emailSelectorPopup';
                popup.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                document.body.appendChild(popup);
                
                // Aggiungi evento per chiudere cliccando fuori
                popup.onclick = function(e) {
                    if (e.target === popup) {
                        closeEmailSelector();
                    }
                };
            }
            
            // Raggruppa contatti per tipo
            const grouped = {};
            contacts.forEach(contact => {
                if (!grouped[contact.type]) {
                    grouped[contact.type] = [];
                }
                grouped[contact.type].push(contact);
            });
            
            popup.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    text-align: center;
                    position: relative;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    max-width: 700px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                ">
                    <button onclick="closeEmailSelector()" style="
                        position: sticky;
                        top: 0;
                        right: 0;
                        float: right;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        line-height: 1;
                        z-index: 10001;
                        margin-bottom: 10px;
                    ">×</button>
                    <h2 style="color: #007bff; margin-bottom: 20px; font-size: 24px; clear: both;">📧 Seleziona Email</h2>
                    <p style="color: #666; font-size: 16px; margin-bottom: 20px;">
                        Sono state trovate <strong>${contacts.length}</strong> email associate a questo ticket.<br>
                        Seleziona quella a cui vuoi scrivere:
                    </p>
                    <div id="emailButtonsContainer">
                        ${Object.keys(grouped).map(type => `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: #495057; font-size: 18px; margin-bottom: 10px; text-align: left; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;">
                                    ${type}
                                </h3>
                                ${grouped[type].map(contact => `
                                    <button onclick="openEmailClient('${contact.email.replace(/'/g, "\\'")}', workData); closeEmailSelector();" style="
                                        display: block;
                                        width: 100%;
                                        margin: 8px 0;
                                        padding: 15px;
                                        background-color: #007bff;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        text-align: left;
                                        transition: background-color 0.3s ease;
                                    " onmouseover="this.style.backgroundColor='#0056b3'" onmouseout="this.style.backgroundColor='#007bff'">
                                        <div style="font-weight: bold; margin-bottom: 5px;">📧 ${contact.email}</div>
                                        <div style="font-size: 12px; opacity: 0.9;">${contact.name}</div>
                                    </button>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                        <button onclick="selectAllEmails()" style="
                            padding: 10px 20px;
                            background-color: #28a745;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Seleziona Tutti</button>
                        <button onclick="closeEmailSelector()" style="
                            padding: 10px 20px;
                            background-color: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 14px;
                        ">Annulla</button>
                    </div>
                </div>
            `;
            
            popup.style.display = 'flex';
        }
        
        // Funzione per selezionare tutte le email
        function selectAllEmails() {
            // Ottieni tutti i contatti email dal popup
            const popup = document.getElementById('emailSelectorPopup');
            const buttons = popup.querySelectorAll('button[onclick*="openEmailClient"]');
            const emails = [];
            
            buttons.forEach(button => {
                const onclick = button.getAttribute('onclick');
                const emailMatch = onclick.match(/openEmailClient\('([^']+)'/);
                if (emailMatch) {
                    emails.push(emailMatch[1]);
                }
            });
            
            if (emails.length > 0) {
                const allEmails = emails.join(';');
                openEmailClient(allEmails, workData);
                closeEmailSelector();
            }
        }
        
        // ===== FUNZIONI UTILITY PER WHATSAPP =====
        
        // Funzione per validare e estrarre numeri di cellulare
        function extractValidCellPhones(phoneString) {
            if (!phoneString) return [];
            
            // Dividi per separatori comuni
            const numbers = phoneString.split(/[,;]|\s{2,}/).map(n => n.trim()).filter(n => n);
            
            return numbers.filter(number => isValidCellPhone(number));
        }
        
        // Funzione per verificare se un numero è un cellulare valido
        function isValidCellPhone(number) {
            if (!number) return false;
            
            // Rimuovi spazi e caratteri non numerici eccetto +
            const cleanNumber = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
            
            // Pattern per numeri italiani: 3XX XXXXXXX (con o senza prefisso internazionale)
            const italianCellPattern = /^(3\d{8,9}|00393\d{8,9}|\+393\d{8,9})$/;
            
            return italianCellPattern.test(cleanNumber);
        }
        
        // Funzione per normalizzare numero per WhatsApp
        function normalizePhoneForWhatsApp(number) {
            let cleanNumber = number.replace(/\s+/g, '').replace(/[^\d+]/g, '');
            
            // Rimuovi prefissi internazionali
            if (cleanNumber.startsWith('+39')) {
                cleanNumber = cleanNumber.substring(3);
            } else if (cleanNumber.startsWith('0039')) {
                cleanNumber = cleanNumber.substring(4);
            }
            
            // Aggiungi prefisso italiano se necessario
            if (!cleanNumber.startsWith('39') && cleanNumber.length === 10) {
                cleanNumber = '39' + cleanNumber;
            }
            
            return cleanNumber;
        }
        
        // Funzione per mostrare alert quando non ci sono numeri WhatsApp
        function showNoWhatsAppAlert(message) {
            let popup = document.getElementById('noWhatsAppPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'noWhatsAppPopup';
                popup.style.cssText = `
                    position: fixed; 
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex; 
                    justify-content: center;
                    align-items: center; 
                    z-index: 10000;
                `;
                
                document.body.appendChild(popup);
            }
            
            popup.innerHTML = `
                    <div style="
                        background: white; 
                    padding: 30px;
                    border-radius: 15px;
                    text-align: center;
                    position: relative;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    max-width: 400px;
                    width: 90%;
                    ">
                    <button onclick="closeNoWhatsAppPopup()" style="
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        line-height: 1;
                    ">×</button>
                    <h2 style="color: #25D366; margin-bottom: 20px; font-size: 24px;">📱 WhatsApp</h2>
                    <p style="color: #666; font-size: 16px; line-height: 1.5;">
                        ${message}
                    </p>
                </div>
            `;
            
            popup.style.display = 'flex';
        }
        
        // Funzione per chiudere il popup no WhatsApp
        function closeNoWhatsAppPopup() {
            const popup = document.getElementById('noWhatsAppPopup');
            if (popup) {
                popup.remove();
            }
        }

        // ===== FUNZIONI EMAIL =====

        // Funzione per mostrare alert quando non ci sono email
        function showNoEmailAlert(message = 'Nessun indirizzo email trovato per questo ticket') {
            let popup = document.getElementById('noEmailPopup');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'noEmailPopup';
                popup.style.cssText = `
                    position: fixed; 
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex; 
                    justify-content: center;
                    align-items: center; 
                    z-index: 10000;
                `;
                
                document.body.appendChild(popup);
            }
            
            popup.innerHTML = `
                <div style="
                    background: white; 
                    padding: 30px;
                    border-radius: 15px;
                    text-align: center;
                    position: relative;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                    max-width: 400px;
                    width: 90%;
                ">
                    <button onclick="closeNoEmailPopup()" style="
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        line-height: 1;
                    ">×</button>
                    <h2 style="color: #dc3545; margin-bottom: 20px; font-size: 24px;">📧 Email non disponibile</h2>
                    <p style="color: #666; font-size: 16px; margin-bottom: 20px;">
                        ${message}
                    </p>
                    <p style="color: #999; font-size: 14px;">
                        Controlla che il cliente, riferimento o fornitori associati abbiano un indirizzo email valido.
                    </p>
                    <button onclick="closeNoEmailPopup()" style="
                        margin-top: 20px;
                        padding: 10px 20px;
                        background-color: #007bff;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                    ">OK</button>
                </div>
            `;
            
            popup.style.display = 'flex';
        }
        
        // Funzione per chiudere popup no email
        function closeNoEmailPopup() {
            const popup = document.getElementById('noEmailPopup');
            if (popup) {
                popup.remove();
            }
        }

        // Funzione per notificare al parent di espandere l'iframe quando necessario
        function expandIframeIfNeeded() {
            try {
                if (window.parent && window.parent.document) {
                    const iframe = window.parent.document.getElementById('contentIframe');
                    const modal = window.parent.document.querySelector('.iframe-content');
                    if (iframe && modal) {
                        // Espandi l'iframe quando si aprono le app-views
                        if (currentView !== 'main') {
                            modal.style.width = '95%';
                            modal.style.height = '95%';
                            modal.style.margin = '1% auto';
                        } else {
                            // Ripristina le dimensioni normali per la vista principale
                            modal.style.width = '90%';
                            modal.style.height = '90%';
                            modal.style.margin = '2% auto';
                        }
                    }
                }
            } catch (error) {
                console.log('Cannot access parent window:', error);
            }
        }

        // Funzione globale accessibile dagli iframe per aggiungere eventi alla cronologia
        window.addToParentHistory = function(type, action, details, entityId = null) {
            if (window.parent && window.parent.addToGlobalHistory) {
                window.parent.addToGlobalHistory(type, action, details, entityId);
            }
        };

        // Inizializzazione per mobile
        function initializeMobile() {
            // Rileva se è mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Aggiungi meta tag per viewport se non esiste
                if (!document.querySelector('meta[name="viewport"]')) {
                    const viewport = document.createElement('meta');
                    viewport.name = 'viewport';
                    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                    document.head.appendChild(viewport);
                }
                
                // Previeni il zoom sui form input
                document.addEventListener('touchstart', function() {}, true);
                
                // Migliora il scrolling touch
                document.body.style.webkitOverflowScrolling = 'touch';
                
                // Assicurati che le app-view siano full screen su mobile
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 768px) {
                        .app-view.active {
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            right: 0 !important;
                            bottom: 0 !important;
                            z-index: 1000 !important;
                            background: white !important;
                            overflow-y: auto !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // ===== SINCRONIZZAZIONE NOMI COLONNE =====
        
        let stageNames = {};
        
        // Carica i nomi personalizzati delle colonne
        async function loadStageNames() {
            try {
                const response = await fetch('/api/get_stage_names/');
                if (response.ok) {
                    stageNames = await response.json();
                    updateStageNamesInUI();
                }
            } catch (error) {
                console.error('Errore nel caricamento dei nomi delle colonne:', error);
            }
        }
        
        // Aggiorna i nomi delle colonne nell'interfaccia
        function updateStageNamesInUI() {
            // Aggiorna il select della fase principale
            const faseSelect = document.getElementById('fase');
            if (faseSelect) {
                Array.from(faseSelect.options).forEach(option => {
                    if (stageNames[option.value]) {
                        option.textContent = stageNames[option.value];
                    }
                });
            }
            
            // Aggiorna il select del modal di spostamento
            const moveSelect = document.getElementById('move-to-stage');
            if (moveSelect) {
                Array.from(moveSelect.options).forEach(option => {
                    if (stageNames[option.value]) {
                        option.textContent = stageNames[option.value];
                    }
                });
            }
        }
        
        // Listener per aggiornamenti in tempo reale dal parent
        function listenForStageNameUpdates() {
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'stageNameUpdated') {
                    // Aggiorna i nomi locali
                    stageNames[event.data.stageKey] = event.data.newName;
                    updateStageNamesInUI();
                }
            });
        }
        
        // Inizializza quando il DOM è pronto
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobile();
            loadStageNames();
            listenForStageNameUpdates();
        });
        
        // Inizializza anche subito nel caso il DOM sia già pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeMobile();
                loadStageNames();
                listenForStageNameUpdates();
            });
        } else {
            initializeMobile();
            loadStageNames();
            listenForStageNameUpdates();
        }
    </script>
</body>
</html>
